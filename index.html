<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focus Space - Zen Focus & Routine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&family=Hind+Siliguri:wght@300;400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        bangla: ['Hind Siliguri', 'sans-serif'],
                        retro: ['"Press Start 2P"', 'cursive'],
                    },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.05)',
                        glassBorder: 'rgba(255, 255, 255, 0.1)',
                        recovery: '#10b981',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'morph': 'morph 8s ease-in-out infinite',
                        'aurora': 'aurora 10s ease infinite',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'glow-pulse': 'glowPulse 2s infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        morph: {
                            '0%': { borderRadius: '60% 40% 30% 70%/60% 30% 70% 40%' },
                            '50%': { borderRadius: '30% 60% 70% 40%/50% 60% 30% 60%' },
                            '100%': { borderRadius: '60% 40% 30% 70%/60% 30% 70% 40%' }
                        },
                        aurora: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' },
                        },
                        glowPulse: {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(99, 102, 241, 0.2)' },
                            '50%': { boxShadow: '0 0 20px rgba(99, 102, 241, 0.6)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --subject-color: #6366f1;
            --glow-spread: 0px;
        }

        body {
            background-color: #050505;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(56, 189, 248, 0.1), transparent 25%);
            color: #e2e8f0;
            overflow-x: hidden;
        }

        /* --- Glassmorphism Utils --- */
        .glass-panel {
            background: rgba(20, 20, 23, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glassBorder);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--glassBorder);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        /* --- PSYCHOLOGICAL FLOW TIMER (Brain Hack Design - DEFAULT ORB) --- */
        .zen-orb-container {
            position: relative;
            width: 320px;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            perspective: 1000px;
        }

        .zen-orb {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.1), transparent 50%),
                        radial-gradient(circle at 70% 70%, var(--subject-color), transparent 70%);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.5), 0 0 30px var(--subject-color);
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(8px);
            z-index: 10;
            opacity: 0.9;
            transform-style: preserve-3d;
            animation: float 8s ease-in-out infinite;
            transition: background 1s ease, box-shadow 1s ease;
        }

        .focus-tunnel {
            position: absolute;
            inset: -50px;
            border-radius: 50%;
            border: 1px dashed var(--subject-color);
            opacity: 0.15;
            animation: tunnelSpin 20s linear infinite;
            pointer-events: none;
            transition: border-color 1s ease;
        }
        
        .focus-tunnel::before {
            content: '';
            position: absolute;
            inset: 20px;
            border-radius: 50%;
            border: 1px dashed var(--subject-color);
            opacity: 0.5;
            animation: tunnelSpin 15s linear infinite reverse;
            transition: border-color 1s ease;
        }

        @keyframes tunnelSpin {
            to { transform: rotate(360deg) scale(0.95); }
        }

        .zen-heartbeat {
            position: absolute;
            inset: 40px;
            border-radius: 50%;
            background: var(--subject-color);
            filter: blur(50px);
            opacity: 0.2;
            z-index: 5;
            animation: heartbeat 1s ease-in-out infinite;
            transition: background 1s ease;
        }

        .zen-breath-ring {
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px solid var(--subject-color);
            opacity: 0.2;
            z-index: 1;
            animation: breatheGuide 6s ease-in-out infinite;
            transition: border-color 1s ease;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); opacity: 0.15; }
            15% { transform: scale(1.05); opacity: 0.25; }
            30% { transform: scale(1); opacity: 0.15; }
        }

        @keyframes breatheGuide {
            0% { transform: scale(0.95); opacity: 0.1; border-width: 1px; }
            50% { transform: scale(1.1); opacity: 0.4; border-width: 3px; }
            100% { transform: scale(0.95); opacity: 0.1; border-width: 1px; }
        }

        /* --- THEME STYLES --- */
        .theme-minimal-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        .theme-cyber-container {
            position: relative;
            padding: 40px;
            border: 2px solid var(--subject-color);
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 20px var(--subject-color);
        }
        .theme-cyber-container::before {
            content: "SYSTEM_ACTIVE";
            position: absolute;
            top: -10px;
            left: 20px;
            background: #000;
            padding: 0 10px;
            color: var(--subject-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }
        .theme-liquid-blob {
            width: 300px;
            height: 300px;
            background: var(--subject-color);
            animation: morph 8s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            opacity: 0.8;
            transition: background 1s ease;
        }
        .theme-aurora-bg {
            position: absolute;
            inset: 0;
            background: linear-gradient(-45deg, #000000, #1a1a2e, var(--subject-color), #000000);
            background-size: 400% 400%;
            animation: aurora 15s ease infinite;
            opacity: 0.4;
            z-index: -1;
        }
        .theme-retro-box {
            background-color: #000;
            border: 4px double var(--subject-color);
            padding: 2rem;
            box-shadow: 4px 4px 0px var(--subject-color);
            font-family: 'Press Start 2P', cursive;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--color);
            background-color: var(--color);
        }

        .ui-faded {
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
        }
        .ui-visible {
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.3s ease;
        }

        .custom-checkbox input:checked + div {
            background-color: var(--checked-color, #6366f1);
            border-color: var(--checked-color, #6366f1);
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .prep-overlay {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .prep-active { opacity: 1; pointer-events: auto; }

        /* Timeline Styles */
        .timeline-container { position: relative; padding-left: 20px; }
        .timeline-line { position: absolute; left: 7px; top: 10px; bottom: 10px; width: 2px; background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); }
        .timeline-item { position: relative; margin-bottom: 24px; }
        .timeline-dot { position: absolute; left: -20px; top: 4px; width: 16px; height: 16px; border-radius: 50%; background: #000; border: 2px solid var(--day-color); box-shadow: 0 0 10px var(--day-color); z-index: 10; }
        .day-header { color: var(--day-color); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .history-card { background: rgba(255, 255, 255, 0.03); border-left: 2px solid var(--day-color); border-radius: 0 12px 12px 0; padding: 12px; }
        
        .session-type-card, .timer-theme-card {
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .session-type-card:hover, .timer-theme-card:hover {
            background: rgba(255,255,255,0.05);
        }
        .session-type-card.selected, .timer-theme-card.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
        }

        /* Routine & Calendar Styling */
        .day-tab { transition: all 0.2s; }
        .day-tab.active-day { background: rgba(255,255,255,0.1); border-color: white; color: white; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
        .calendar-day-header { text-align: center; font-size: 0.75rem; font-weight: 700; color: #64748b; padding-bottom: 8px; text-transform: uppercase; }
        .calendar-day-header.weekend { color: #f87171; }
        .calendar-day { min-height: 120px; border-radius: 12px; display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start; padding: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .calendar-day:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
        .calendar-day.weekend { background: rgba(239, 68, 68, 0.05); border-color: rgba(239, 68, 68, 0.1); }
        .calendar-day.today { background: rgba(99, 102, 241, 0.1); border: 1px solid #6366f1; box-shadow: 0 0 15px rgba(99, 102, 241, 0.15); }
        .calendar-date-number { align-self: flex-start; font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; }

        .calendar-event-tag { background: linear-gradient(90deg, rgba(244, 114, 182, 0.2) 0%, rgba(244, 114, 182, 0.1) 100%); border-left: 3px solid #f472b6; color: #fbcfe8; font-size: 0.7rem; padding: 4px 6px; border-radius: 0 4px 4px 0; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; text-align: left; font-weight: 500; }
        .countdown-card { background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(168,85,247,0.1) 100%); border: 1px solid rgba(255,255,255,0.1); }

        /* Mobile Header */
        .mobile-header { background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glassBorder); }

        /* --- UPDATED: DAY VIEW & ANALYTICS STYLES --- */
        
        /* Smart HUD Cards */
        .smart-hud-card {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            position: relative;
            overflow: hidden;
        }
        
        .smart-hud-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
        }

        .smart-hud-card::after {
            content: '';
            position: absolute;
            bottom: -1px; right: -1px;
            width: 20px; height: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            border-right: 2px solid rgba(255, 255, 255, 0.2);
        }

        /* Efficiency Ring */
        .efficiency-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(var(--ring-color) var(--percent), rgba(255,255,255,0.05) 0);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .efficiency-ring::before {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            background: #0f172a;
            z-index: 1;
        }
        .efficiency-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        /* Analytics Specifics */
        .analytics-badge {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .day-report-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media(min-width: 768px) {
            .day-report-grid { grid-template-columns: 1.2fr 0.8fr; }
        }

        .session-timeline-item {
            position: relative;
            padding-left: 1.5rem;
            padding-bottom: 1.5rem;
            border-left: 1px solid rgba(255,255,255,0.1);
        }
        .session-timeline-item:last-child {
            border-left: 1px solid transparent;
        }
        .session-timeline-dot {
            position: absolute;
            left: -5px;
            top: 4px;
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 10px currentColor;
        }

        /* --- IMPROVED STUDY FLOW STYLES (ANIMATIONS & INTERACTION) --- */
        
        /* Table Container & Scrollbar */
        .flow-table-container {
            position: relative;
            background: rgba(10, 10, 12, 0.5);
            border-radius: 1rem;
        }
        .flow-table-container::-webkit-scrollbar { height: 10px; width: 10px; }
        .flow-table-container::-webkit-scrollbar-track { background: transparent; }
        .flow-table-container::-webkit-scrollbar-thumb { 
            background: #334155; 
            border-radius: 5px; 
            border: 2px solid #0a0a0c;
        }
        .flow-table-container::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Table Header Cells (Columns) */
        .flow-header-cell {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            color: #94a3b8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-bottom: 2px solid rgba(255,255,255,0.05);
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 1rem 1.25rem;
            transition: all 0.2s ease;
        }
        
        .flow-header-cell:hover {
            background: rgba(56, 189, 248, 0.1); /* Cyan tint on hover */
            color: #fff;
        }

        /* Delete Column Button */
        .col-delete-btn {
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .flow-header-cell:hover .col-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .col-delete-btn:hover {
            color: #f87171; /* Red */
            transform: scale(1.2) rotate(90deg);
        }

        /* Table Rows */
        tbody tr {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
            transform: scale(1.005);
            box-shadow: 0 4px 20px -10px rgba(0,0,0,0.5);
            z-index: 10;
            position: relative;
        }

        /* Chapter Name Input */
        .flow-chapter-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: #e2e8f0;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            padding: 0.5rem 0;
            transition: all 0.3s ease;
            position: relative;
        }
        .flow-chapter-input:hover {
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-left: 0.5rem;
        }
        .flow-chapter-input:focus {
            outline: none;
            background: rgba(34, 211, 238, 0.05);
            border-bottom: 1px solid #22d3ee;
            color: #fff;
            padding-left: 0.5rem;
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
        }

        /* Progress Section Wrapper */
        .flow-progress-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            min-width: 160px;
        }

        /* Progress Bar Track & Fill */
        .progress-track {
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 99px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy animation */
            position: relative;
        }
        
        /* Shimmer effect for progress bars */
        .progress-fill::after {
            display: none; /* no shimmer - removed per user request */
        }

        /* Additional progress animation utilities (copied from bol;.html) */
        .progress-wrapper {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 999px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Progress Color Classes */
        .prog-low { background-color: #ef4444; color: #ef4444; box-shadow: 0 0 10px rgba(239,68,68,0.2); }
        .prog-med { background-color: #f59e0b; color: #f59e0b; box-shadow: 0 0 10px rgba(245,158,11,0.2); }
        .prog-high { background-color: #10b981; color: #10b981; box-shadow: 0 0 10px rgba(16,185,129,0.2); }
        

        /* Status Specific Colors */
        .status-finished .progress-fill { background: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .status-not-finished .progress-fill { background: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .status-pending .progress-fill { background: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }

        /* Status Select Dropdown */
        .flow-status-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: #94a3b8;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .flow-status-select:hover, .flow-status-select:focus {
            border-color: #22d3ee;
            color: #fff;
            outline: none;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
        }

        /* Interactive Cell (Icons) */
        .flow-cell-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            height: 100px; /* Taller for interaction */
            padding: 0.5rem;
        }

        .flow-cell-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy */
        }

        .flow-cell-icon:hover {
            transform: translateY(-4px) scale(1.1);
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.5);
        }

        .flow-cell-icon:active {
            transform: scale(0.95);
        }

        /* Note Cell */
        .flow-note-cell {
            width: 100%;
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            background: transparent;
            border: 1px dashed transparent;
            border-radius: 6px;
            padding: 4px;
            cursor: text;
            transition: all 0.2s;
            outline: none;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .flow-note-cell:hover {
            background: rgba(255,255,255,0.03);
            color: #e2e8f0;
            border-color: rgba(255,255,255,0.1);
        }

        .flow-note-cell:focus {
            background: rgba(0,0,0,0.4);
            color: #22d3ee;
            border-color: #22d3ee;
            white-space: normal;
            overflow: visible;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        /* Icon States */
        .icon-done { 
            background: rgba(16, 185, 129, 0.15); 
            border-color: rgba(16, 185, 129, 0.3); 
            color: #10b981; 
            box-shadow: 0 0 0 rgba(16, 185, 129, 0); 
        }
        .icon-done:hover {
             box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); 
        }

        .icon-skipped { 
            background: rgba(239, 68, 68, 0.15); 
            border-color: rgba(239, 68, 68, 0.3); 
            color: #ef4444;
            box-shadow: 0 0 0 rgba(239, 68, 68, 0); 
        }
        .icon-skipped:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

    </style>
</head>
<body class="antialiased selection:bg-indigo-500/30">

    <!-- App Wrapper -->
    <div id="app" class="min-h-screen flex flex-col lg:flex-row relative">
        
        <!-- Mobile Header -->
        <div class="lg:hidden mobile-header sticky top-0 z-40 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 hover:bg-white/10 active:bg-white/20 transition-colors border border-white/5">
                    <i class="fas fa-bars text-slate-200 text-lg"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center">
                        <i class="fas fa-brain text-white text-[10px]"></i>
                    </div>
                    <h1 class="text-lg font-black tracking-tighter text-white">Focus Space</h1>
                </div>
            </div>
             <span class="text-xs font-mono text-slate-500" id="mobileDate">Today</span>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden lg:hidden transition-opacity duration-300"></div>

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-[#0a0a0c] lg:bg-transparent lg:static transform -translate-x-full lg:translate-x-0 transition-transform duration-300 glass-panel lg:border-r border-r border-white/5 flex flex-col h-screen overflow-y-auto">
            <div class="p-8 pb-0">
                <div class="flex items-center justify-between gap-3 mb-10">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <h1 class="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-300 drop-shadow-sm">Focus Space</h1>
                    </div>
                    <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <nav class="space-y-2">
                    <button onclick="navClick('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group active" id="nav-dashboard">
                        <i class="fas fa-layer-group w-5 group-hover:text-indigo-400 transition-colors"></i> Dashboard
                    </button>
                    <button onclick="navClick('tasks')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group" id="nav-tasks">
                        <i class="fas fa-list-check w-5 group-hover:text-pink-400 transition-colors"></i> Tasks
                    </button>
                    
                    <!-- REPLACED SOUNDS WITH STUDY FLOW -->
                    <button onclick="navClick('flow')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group" id="nav-flow">
                        <i class="fas fa-book-open w-5 group-hover:text-cyan-400 transition-colors"></i> StudyFlow
                    </button>
                    <!-- END REPLACEMENT -->

                    <button onclick="navClick('calendar')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group" id="nav-calendar">
                        <i class="fas fa-calendar-alt w-5 group-hover:text-red-400 transition-colors"></i> Calendar
                    </button>
                    <button onclick="navClick('web')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group" id="nav-web">
                        <i class="fas fa-globe w-5 group-hover:text-emerald-400 transition-colors"></i> Study Web
                    </button>
                    <button onclick="navClick('routine')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group" id="nav-routine">
                        <i class="fas fa-calendar-week w-5 group-hover:text-teal-400 transition-colors"></i> Routine
                    </button>
                    <button onclick="navClick('analytics')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group" id="nav-analytics">
                        <i class="fas fa-chart-pie w-5 group-hover:text-purple-400 transition-colors"></i> Analytics
                    </button>
                    <button onclick="navClick('settings')" class="nav-btn w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-slate-400 hover:text-white group" id="nav-settings">
                        <i class="fas fa-sliders w-5 group-hover:text-pink-400 transition-colors"></i> Settings
                    </button>
                </nav>
            </div>

            <!-- Sidebar Footer Area (Reusing for stats) -->
            <div class="mt-auto p-8 border-t border-white/5">
                <div class="mt-6 pt-6 border-t border-white/5">
                    <div class="flex items-center justify-between text-xs text-slate-500 uppercase tracking-widest font-bold mb-2">
                        <span>Daily Flow</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
                        <div id="totalProgressBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 transition-all duration-1000"></div>
                    </div>
                    <div class="mt-4">
                        <p class="text-xs text-slate-400">Total Focus</p>
                        <p class="text-2xl font-mono font-bold text-white mt-1 leading-none" id="sidebarTotalTime">00:00</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 lg:p-10 max-w-7xl mx-auto w-full pb-24 lg:pb-10 overflow-hidden">
            
            <!-- Dashboard View -->
            <div id="dashboardView" class="view animate-fade-in">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <p class="text-slate-400 text-sm font-medium mb-1" id="currentDate">Monday, Jan 1</p>
                        <h2 class="text-5xl font-black italic tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white via-indigo-100 to-slate-500 drop-shadow-[0_0_15px_rgba(255,255,255,0.1)]">Focus Space</h2>
                    </div>
                    <button onclick="openAddSubjectModal()" class="w-full md:w-auto bg-white text-black hover:bg-indigo-50 px-6 py-3 rounded-xl font-medium flex items-center justify-center gap-2 transition-all shadow-[0_0_20px_rgba(255,255,255,0.1)] hover:shadow-[0_0_25px_rgba(255,255,255,0.2)]">
                        <i class="fas fa-plus"></i> New Subject
                    </button>
                </header>

                <div id="upcomingEventsContainer" class="hidden mb-8"></div>

                <div id="todaysGoalsSection" class="hidden mb-10">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-crosshairs text-teal-400"></i> Today's Schedule
                    </h3>
                    <div id="todaysGoalsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <div id="subjectsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5 mb-10"></div>
                
                <div id="emptyState" class="hidden flex flex-col items-center justify-center py-10 text-center opacity-50">
                    <i class="fas fa-seedling text-4xl mb-4 text-slate-600"></i>
                    <p class="text-slate-400">No subjects yet. Add one to start studying.</p>
                </div>
            </div>

            <!-- Tasks View -->
            <div id="tasksView" class="view hidden animate-fade-in">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Task Management</h2>
                    <p class="text-slate-400">Plan your day and track your weekly journey.</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-list-check text-indigo-400"></i> Today's Focus
                        </h3>
                        <div class="glass-card rounded-2xl p-6 h-[600px] flex flex-col">
                            <div class="flex gap-4 mb-6">
                                <input type="text" id="todoInput" placeholder="Add daily task..." 
                                    class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500 transition-all placeholder:text-slate-600"
                                    onkeypress="if(event.key === 'Enter') addTodo()">
                                <button onclick="addTodo()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 rounded-xl font-medium transition-colors">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="todoList" class="space-y-3 flex-1 overflow-y-auto pr-2 custom-scrollbar"></div>
                            <div id="emptyTodo" class="text-center py-6 text-slate-500 text-sm italic hidden">Ready to start your day?</div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fas fa-history text-pink-400"></i> Weekly Journey
                        </h3>
                        <div class="glass-card rounded-2xl p-6 h-[600px] overflow-hidden flex flex-col">
                            <div id="weeklyLogList" class="timeline-container flex-1 overflow-y-auto pr-2 custom-scrollbar pt-2">
                                <div class="timeline-line"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW STUDY FLOW VIEW -->
            <div id="flowView" class="view hidden animate-fade-in h-full flex flex-col">
                <!-- Flow Dashboard (Subject List) -->
                <div id="flowDashboard" class="flex flex-col h-full">
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-indigo-400">StudyFlow</h2>
                            <p class="text-slate-400 text-sm">Track detailed syllabus progress.</p>
                        </div>
                        <button onclick="openAddFlowSubjectModal()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-3 rounded-xl font-medium flex items-center justify-center gap-2 transition-all shadow-lg shadow-cyan-600/20">
                            <i class="fas fa-plus"></i> New Subject
                        </button>
                    </header>
                    
                    <div id="flowSubjectsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 flex-1 overflow-y-auto pr-2 custom-scrollbar"></div>
                    
                    <div id="emptyFlowState" class="hidden flex flex-col items-center justify-center py-20 text-center opacity-50 border-2 border-dashed border-white/5 rounded-3xl">
                        <i class="fas fa-book text-5xl mb-4 text-slate-600"></i>
                        <p class="text-slate-400 text-lg">No StudyFlow subjects yet.</p>
                    </div>
                </div>

                <!-- Flow Detail View (Table) -->
                <div id="flowDetailView" class="hidden flex flex-col h-full bg-[#0a0a0c]/80 backdrop-blur-xl rounded-2xl border border-white/5 shadow-2xl overflow-hidden">
                    <div class="p-4 border-b border-white/5 bg-black/20 flex justify-between items-center z-20">
                        <div class="flex items-center gap-4">
                            <button onclick="showFlowDashboard()" class="w-8 h-8 rounded-lg bg-white/5 hover:bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <h3 id="currentFlowSubjectTitle" class="text-xl font-bold text-white">Physics</h3>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="openAddFlowColumnModal()" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-xs font-bold text-slate-300 border border-white/5 transition-colors">
                                + Column
                            </button>
                            <button onclick="addFlowChapter()" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-xs font-bold text-white shadow-lg shadow-indigo-600/20 transition-colors">
                                + Chapter
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-auto flow-table-container relative">
                        <table class="w-full border-collapse min-w-[900px]">
                            <thead>
                                <!-- Added ID for Header Row to target it in JS -->
                                <tr id="flowHeaderRow" class="text-xs sticky top-0 z-20 shadow-lg">
                                    <!-- Headers Injected Here -->
                                </tr>
                            </thead>
                            <tbody id="flowTableBody" class="text-sm text-slate-300 divide-y divide-white/5">
                                <!-- Rows Injected Here -->
                            </tbody>
                        </table>
                        <div id="emptyFlowTable" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-500 text-center p-10">
                            <p>No chapters added yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Routine View -->
            <div id="routineView" class="view hidden animate-fade-in">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold mb-2">Weekly Routine</h2>
                    <p class="text-slate-400">Design your perfect week.</p>
                </header>
                <div class="glass-card rounded-2xl p-6 lg:p-8">
                    <div class="flex overflow-x-auto gap-2 mb-8 pb-2 custom-scrollbar" id="daySelector"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white/5 rounded-xl p-6 border border-white/5 h-fit">
                            <h3 class="font-bold text-lg mb-4 text-white">Add Schedule for <span id="selectedDayLabel" class="text-teal-400">Monday</span></h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Subject</label>
                                    <select id="routineSubjectSelect" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Target Time (Minutes)</label>
                                    <input type="number" id="routineTargetTime" placeholder="e.g. 60" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500">
                                </div>
                                <button onclick="addToRoutine()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-medium shadow-lg shadow-indigo-600/20 transition-all"><i class="fas fa-plus mr-2"></i> Add to Day</button>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div id="routineListForDay" class="space-y-3"></div>
                            <div id="emptyRoutine" class="text-center py-12 border-2 border-dashed border-white/5 rounded-xl text-slate-500 hidden"><i class="fas fa-calendar-plus mb-2 text-2xl opacity-50"></i><p>No subjects scheduled for this day.</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarView" class="view hidden animate-fade-in">
                <header class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Academic Calendar</h2>
                        <p class="text-slate-400 text-sm mt-1">Plan exams and deadlines. <span class="text-red-400 ml-2"><i class="fas fa-square mr-1 text-xs"></i>BD Weekends (Fri/Sat)</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="currentMonthLabel" class="text-xl font-bold min-w-[150px] text-center flex items-center justify-center">January 2024</h3>
                        <button onclick="changeMonth(1)" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </header>
                <div class="glass-card rounded-2xl p-6">
                    <div class="calendar-grid mb-4">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header weekend">Fri</div>
                        <div class="calendar-day-header weekend">Sat</div>
                    </div>
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>
            </div>

             <!-- Web View -->
             <div id="webView" class="view hidden animate-fade-in">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Allowed Websites</h2>
                        <p class="text-slate-400 text-sm mt-1">Whitelisted resources. <span class="text-emerald-400">Note: Disable Strict Mode to use.</span></p>
                    </div>
                    <button onclick="openAddWebModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-medium flex items-center gap-2 transition-all shadow-lg shadow-emerald-600/20">
                        <i class="fas fa-plus"></i> Add Website
                    </button>
                </header>
                <div id="allowedWebGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                <div id="emptyWebState" class="hidden flex flex-col items-center justify-center py-20 text-center opacity-50 border-2 border-dashed border-white/5 rounded-2xl">
                    <i class="fas fa-wifi text-4xl mb-4 text-slate-600"></i>
                    <p class="text-slate-400">No allowed websites yet.</p>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analyticsView" class="view hidden">
                <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">Performance <span class="text-indigo-500">.ai</span></h2>
                        <p class="text-slate-400 text-sm mt-1">Deep learning insights from your study patterns.</p>
                    </div>
                    <!-- Time Period Filter -->
                    <div class="flex items-center gap-3 bg-black/40 p-1 rounded-lg border border-white/10 backdrop-blur-sm">
                        <button onclick="setAnalyticsFilter('7d')" id="btn-filter-7d" class="px-4 py-1.5 rounded text-sm font-medium bg-indigo-600 text-white transition-all shadow-lg shadow-indigo-500/20">7 Days</button>
                        <button onclick="setAnalyticsFilter('30d')" id="btn-filter-30d" class="px-4 py-1.5 rounded text-sm font-medium text-slate-400 hover:text-white transition-all">30 Days</button>
                        <div class="relative">
                             <input type="date" id="customDateInput" onchange="setAnalyticsFilter('custom')" class="bg-black/30 border border-white/10 text-white text-sm rounded px-2 py-1 focus:outline-none focus:border-indigo-500 w-32 cursor-pointer">
                        </div>
                    </div>
                </header>

                <!-- AI Analysis Report Section -->
                <div id="aiAnalysisResults" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 hidden">
                    <!-- Most Read -->
                    <div class="smart-hud-card rounded-2xl p-6 flex flex-col items-center justify-center text-center border-t-4 border-t-green-500 relative group">
                        <div class="absolute inset-0 bg-gradient-to-b from-green-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                        <div class="w-14 h-14 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 mb-3 text-xl shadow-[0_0_15px_rgba(74,222,128,0.3)]">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <p class="text-[10px] uppercase font-bold tracking-widest text-slate-400 mb-1">Dominant Subject</p>
                        <h4 id="statMostRead" class="text-lg font-bold text-white tracking-wide">-</h4>
                    </div>
                    <!-- Least Read -->
                    <div class="smart-hud-card rounded-2xl p-6 flex flex-col items-center justify-center text-center border-t-4 border-t-rose-500 relative group">
                        <div class="absolute inset-0 bg-gradient-to-b from-rose-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                        <div class="w-14 h-14 rounded-full bg-rose-500/20 flex items-center justify-center text-rose-400 mb-3 text-xl shadow-[0_0_15px_rgba(244,63,94,0.3)]">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <p class="text-[10px] uppercase font-bold tracking-widest text-slate-400 mb-1">Neglected Area</p>
                        <h4 id="statLeastRead" class="text-lg font-bold text-white tracking-wide">-</h4>
                    </div>
                    <!-- Suggestions -->
                    <div class="smart-hud-card rounded-2xl p-6 border-t-4 border-t-yellow-500 relative overflow-hidden group bg-gradient-to-br from-yellow-500/5 to-transparent">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/10 rounded-full blur-2xl group-hover:bg-yellow-500/20 transition-all"></div>
                        <div class="relative z-10">
                            <p class="text-[10px] uppercase font-bold tracking-widest text-slate-400 mb-2">Neural Suggestion</p>
                            <p id="statSuggestion" class="text-sm text-yellow-100 font-medium leading-relaxed">Gathering data...</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Daily Chart -->
                    <div class="smart-hud-card rounded-2xl p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 flex items-center gap-2">
                                <i class="fas fa-chart-bar text-indigo-400"></i> Focus Trend
                            </h3>
                             <span class="analytics-badge text-indigo-400">HOURS</span>
                        </div>
                        <div class="relative h-72 w-full"><canvas id="dailyChart"></canvas></div>
                    </div>
                    <!-- Distribution Chart -->
                    <div class="smart-hud-card rounded-2xl p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 flex items-center gap-2">
                                <i class="fas fa-chart-pie text-purple-400"></i> Distribution
                            </h3>
                             <span class="analytics-badge text-purple-400">TOTAL</span>
                        </div>
                        <div class="relative h-72 w-full flex items-center justify-center"><canvas id="distributionChart"></canvas></div>
                    </div>
                </div>

                <!-- NEW: SYLLABUS PROGRESS CHART (STUDY FLOW) -->
                <div class="smart-hud-card rounded-2xl p-8 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 flex items-center gap-2">
                            <i class="fas fa-book-reader text-cyan-400"></i> Syllabus Coverage
                        </h3>
                        <span class="analytics-badge text-cyan-400">FLOW DATA</span>
                    </div>
                    <div class="relative h-64 w-full"><canvas id="syllabusChart"></canvas></div>
                </div>
                
                <!-- Recent Sessions List -->
                <div class="smart-hud-card rounded-2xl p-6">
                    <h3 class="text-sm font-bold uppercase tracking-wider text-slate-400 mb-6 border-b border-white/5 pb-4 flex justify-between items-center">
                        <span><i class="fas fa-history mr-2 text-cyan-400"></i> Session Log</span>
                        <span class="text-[10px] text-slate-500 font-normal">RECENT ACTIVITY</span>
                    </h3>
                    <div id="recentSessions" class="space-y-0"></div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settingsView" class="view hidden">
                <h2 class="text-3xl font-bold mb-8">Settings</h2>
                <div class="grid gap-6 max-w-2xl">
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="p-6 border-b border-white/5">
                            <h3 class="font-bold text-lg mb-1">Data Management</h3>
                            <p class="text-sm text-slate-500">Control your local storage data</p>
                        </div>
                        <div class="p-6 space-y-4 bg-black/20">
                             <button onclick="exportData()" class="w-full flex items-center justify-between p-4 rounded-xl bg-white/5 hover:bg-white/10 transition-colors">
                                <span class="flex items-center gap-3"><i class="fas fa-download text-indigo-400"></i> Export Data (JSON)</span><i class="fas fa-chevron-right text-xs text-slate-600"></i>
                            </button>
                            <button onclick="clearData()" class="w-full flex items-center justify-between p-4 rounded-xl bg-red-500/5 hover:bg-red-500/10 border border-red-500/20 transition-colors group">
                                <span class="flex items-center gap-3 text-red-400 group-hover:text-red-300"><i class="fas fa-trash"></i> Reset All Progress</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="p-6 border-b border-white/5">
                            <h3 class="font-bold text-lg mb-1">Timer Quotes</h3>
                            <p class="text-sm text-slate-500">Customize the motivational text.</p>
                        </div>
                        <div class="p-6 space-y-4 bg-black/20">
                            <div class="flex items-center justify-between">
                                <span class="text-slate-300">Show Quotes</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="showQuotesToggle" class="sr-only peer" onchange="toggleQuotesSetting()">
                                    <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                </label>
                            </div>
                            <div id="quoteLanguageOption" class="flex items-center justify-between transition-opacity duration-300">
                                <span class="text-slate-300">Language</span>
                                <select id="quoteLanguageSelect" onchange="changeQuoteLanguage()" class="bg-black/30 border border-white/10 rounded-lg px-3 py-1 text-sm text-white focus:outline-none">
                                    <option value="bangla">Bangla Literature</option>
                                    <option value="english">English</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="p-6 border-b border-white/5">
                            <h3 class="font-bold text-lg mb-1">Custom Mantras</h3>
                            <p class="text-sm text-slate-500">Add your own motivational phrases.</p>
                        </div>
                        <div class="p-6 bg-black/20">
                            <div class="flex gap-3 mb-4">
                                <input type="text" id="newMantraInput" placeholder="e.g., I will succeed..." class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-2 text-white focus:outline-none focus:border-indigo-500">
                                <button onclick="addMantra()" class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded-xl text-white"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="mantraList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals & Overlays -->
    <div id="prepOverlay" class="prep-overlay flex flex-col items-center justify-center">
        <div class="text-6xl font-bold text-white mb-8 tracking-widest" id="prepCount">3</div>
        <p class="text-indigo-300 text-lg uppercase tracking-[0.3em] animate-pulse" id="prepText">Breathe In</p>
    </div>

    <!-- Add Subject Modal -->
    <div id="addSubjectModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAddSubjectModal()"></div>
        <div class="glass-panel w-full max-w-md rounded-3xl p-8 relative transform transition-all scale-100 border border-white/10">
            <h3 class="text-2xl font-bold mb-6">New Subject</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Subject Name</label>
                    <input type="text" id="subjectName" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder:text-slate-600" placeholder="e.g. Physics">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Theme Color</label>
                    <div class="flex flex-wrap gap-3" id="colorPicker"></div>
                    <input type="hidden" id="selectedColor" value="#6366f1">
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="closeAddSubjectModal()" class="flex-1 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button onclick="addSubject()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-medium shadow-lg shadow-indigo-600/20 transition-all">Create</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ADD EVENT MODAL -->
    <div id="addEventModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAddEventModal()"></div>
        <div class="glass-panel w-full max-w-md rounded-3xl p-8 relative transform transition-all scale-100 border border-white/10">
            <h3 class="text-2xl font-bold mb-2">Manage Events</h3>
            <p class="text-slate-400 text-sm mb-6" id="eventModalDateLabel">Date</p>
            <div id="existingEventsList" class="space-y-3 mb-6 max-h-48 overflow-y-auto custom-scrollbar"></div>
            <div class="space-y-5 border-t border-white/10 pt-4">
                <h4 class="text-sm font-bold text-slate-400">Add New Event</h4>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Event Title</label>
                    <input type="text" id="eventTitle" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500 placeholder:text-slate-600" placeholder="e.g. Math Final Exam">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Time (Optional)</label>
                    <input type="time" id="eventTime" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500" value="09:00">
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="closeAddEventModal()" class="flex-1 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button onclick="addEvent()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-medium shadow-lg shadow-indigo-600/20 transition-all">Save Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD WEBSITE MODAL -->
    <div id="addWebModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAddWebModal()"></div>
        <div class="glass-panel w-full max-w-md rounded-3xl p-8 relative transform transition-all scale-100 border border-white/10">
            <h3 class="text-2xl font-bold mb-6">Add Allowed Site</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Site Title</label>
                    <input type="text" id="webTitle" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-emerald-500 placeholder:text-slate-600" placeholder="e.g. Khan Academy">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">URL (Link)</label>
                    <input type="text" id="webUrl" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-emerald-500 placeholder:text-slate-600" placeholder="e.g. https://www.khanacademy.org">
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="closeAddWebModal()" class="flex-1 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button onclick="addWebsite()" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-white font-medium shadow-lg shadow-emerald-600/20 transition-all">Add Site</button>
                </div>
            </div>
        </div>
    </div>

    <!-- STUDY FLOW: ADD SUBJECT MODAL -->
    <div id="addFlowSubjectModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAddFlowSubjectModal()"></div>
        <div class="glass-panel w-full max-w-md rounded-3xl p-8 relative transform transition-all scale-100 border border-white/10">
            <h3 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-indigo-400 mb-6" id="flowSubjectModalTitle">New Flow Subject</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Subject Name</label>
                    <input type="text" id="flowSubjectName" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-cyan-500 transition-all placeholder:text-slate-600" placeholder="e.g. Physics 1st Paper">
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="closeAddFlowSubjectModal()" class="flex-1 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button onclick="saveFlowSubject()" class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-white font-medium shadow-lg shadow-cyan-600/20 transition-all" id="btnSaveFlowSubject">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- STUDY FLOW: ADD COLUMN MODAL -->
    <div id="addFlowColumnModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeAddFlowColumnModal()"></div>
        <div class="glass-panel w-full max-w-md rounded-3xl p-8 relative transform transition-all scale-100 border border-white/10">
            <h3 class="text-2xl font-bold mb-6">Add Tracker Column</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Column Name</label>
                    <input type="text" id="flowColumnName" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-cyan-500 transition-all placeholder:text-slate-600" placeholder="e.g. Board Test Solve">
                </div>
                <div class="pt-4 flex gap-3">
                    <button onclick="closeAddFlowColumnModal()" class="flex-1 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-colors">Cancel</button>
                    <button onclick="addFlowColumn()" class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-white font-medium shadow-lg shadow-cyan-600/20 transition-all">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DAY VIEW MODAL (Drill Down) - REDESIGNED -->
    <div id="dayViewModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="closeDayView()"></div>
        <div class="glass-panel w-full max-w-3xl rounded-3xl relative transform transition-all scale-100 border border-white/10 max-h-[90vh] overflow-y-auto custom-scrollbar p-8">
            <button onclick="closeDayView()" class="absolute top-6 right-6 text-slate-400 hover:text-white z-10 bg-black/20 rounded-full w-10 h-10 flex items-center justify-center backdrop-blur-md hover:bg-white/10 transition-all">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Header Section -->
            <div class="mb-8 border-b border-white/5 pb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <p class="text-indigo-400 text-xs font-bold tracking-[0.2em] uppercase mb-2">Daily Report</p>
                        <h3 class="text-3xl font-bold text-white tracking-tight" id="dayViewTitle">Date Details</h3>
                    </div>
                    
                    <!-- Efficiency Ring -->
                    <div class="flex items-center gap-6 bg-black/30 p-4 rounded-2xl border border-white/5">
                        <div class="efficiency-ring" id="dayEfficiencyRing" style="--ring-color: #6366f1; --percent: 0%;">
                            <div class="efficiency-content">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold">Tasks</span>
                                <span class="block text-xl font-bold text-white" id="dayEfficiencyScore">0%</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Total Focus</p>
                            <h4 id="dayViewTotalTime" class="text-2xl font-mono font-bold text-white tracking-tight">00:00:00</h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="day-report-grid">
                <!-- Left: Tasks -->
                <div class="bg-white/5 rounded-2xl p-6 border border-white/5 flex flex-col h-full">
                    <h4 class="text-sm font-bold text-slate-300 mb-6 flex items-center gap-2">
                        <i class="fas fa-tasks text-teal-400"></i> Tasks Completed
                    </h4>
                    <div id="dayViewTasks" class="space-y-3 flex-1">
                        <!-- Tasks injected here -->
                    </div>
                    <button onclick="openAddEventModal(selectedCalendarDate); document.getElementById('dayViewModal').classList.add('hidden');" class="mt-6 w-full py-2 rounded-xl border border-dashed border-white/20 text-xs font-bold text-slate-400 hover:text-white hover:border-white/50 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-calendar-plus"></i> Add Event
                    </button>
                </div>
                
                <!-- Right: Sessions Timeline -->
                <div class="bg-white/5 rounded-2xl p-6 border border-white/5 flex flex-col h-full">
                    <h4 class="text-sm font-bold text-slate-300 mb-6 flex items-center gap-2">
                        <i class="fas fa-clock text-pink-400"></i> Sessions Log
                    </h4>
                    <div id="dayViewSessions" class="space-y-0 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Sessions injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Setup Modal -->
    <div id="sessionSetupModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="closeSessionSetup()"></div>
        <div class="glass-panel w-full max-w-lg rounded-3xl p-8 relative transform transition-all scale-100 border border-white/10 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="text-center mb-8">
                <h3 class="text-2xl font-bold text-white mb-2">Design Your Session</h3>
                <p class="text-slate-400 text-sm">Set your intention for this block.</p>
            </div>
            
            <!-- Mode Selection -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div id="modeFlow" class="session-type-card selected rounded-xl p-4 bg-white/5 text-center" onclick="selectSessionMode('flow')">
                    <i class="fas fa-infinity text-2xl mb-3 text-indigo-400"></i>
                    <h4 class="font-bold text-white mb-1">Flow State</h4>
                    <p class="text-[10px] text-slate-400">Open-ended stopwatch.</p>
                </div>
                <div id="modeCycle" class="session-type-card rounded-xl p-4 text-center" onclick="selectSessionMode('cycle')">
                    <i class="fas fa-hourglass-half text-2xl mb-3 text-teal-400"></i>
                    <h4 class="font-bold text-white mb-1">Cognitive Cycle</h4>
                    <p class="text-[10px] text-slate-400">Structured Intervals.</p>
                </div>
            </div>
            
            <div id="cycleSettings" class="hidden space-y-6 mb-8 bg-white/5 p-4 rounded-xl border border-white/5">
                <div>
                    <div class="flex justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-2"><span>Focus Block</span><span id="focusTimeDisplay" class="text-white">25 min</span></div>
                    <input type="range" id="focusSlider" min="15" max="90" step="5" value="25" oninput="updateRangeDisplays()">
                </div>
                <div>
                    <div class="flex justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-2"><span>Neural Recovery</span><span id="breakTimeDisplay" class="text-teal-400">5 min</span></div>
                    <input type="range" id="breakSlider" min="2" max="30" step="1" value="5" oninput="updateRangeDisplays()">
                </div>
            </div>

            <!-- Timer Theme Selector -->
            <div class="mb-8">
                 <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Timer Style</h4>
                 <div class="flex gap-3 overflow-x-auto pb-2 custom-scrollbar">
                     <div onclick="selectTimerTheme('orb')" id="theme-orb" class="timer-theme-card selected min-w-[80px] p-2 rounded-lg bg-white/5 border border-white/10 text-center flex flex-col items-center gap-2">
                         <div class="w-8 h-8 rounded-full bg-indigo-500 shadow-[0_0_10px_#6366f1]"></div>
                         <span class="text-[10px] text-slate-300">Zen Orb</span>
                     </div>
                     <div onclick="selectTimerTheme('minimal')" id="theme-minimal" class="timer-theme-card min-w-[80px] p-2 rounded-lg border border-white/10 text-center flex flex-col items-center gap-2">
                         <div class="w-8 h-8 flex items-center justify-center font-bold text-lg">Aa</div>
                         <span class="text-[10px] text-slate-300">Minimal</span>
                     </div>
                     <div onclick="selectTimerTheme('cyber')" id="theme-cyber" class="timer-theme-card min-w-[80px] p-2 rounded-lg border border-white/10 text-center flex flex-col items-center gap-2">
                         <div class="w-8 h-8 flex items-center justify-center font-mono text-cyan-400 border border-cyan-400 bg-black text-xs">00</div>
                         <span class="text-[10px] text-slate-300">Cyber</span>
                     </div>
                     <div onclick="selectTimerTheme('liquid')" id="theme-liquid" class="timer-theme-card min-w-[80px] p-2 rounded-lg border border-white/10 text-center flex flex-col items-center gap-2">
                         <div class="w-8 h-8 rounded-[40%_60%_70%_30%] bg-pink-500"></div>
                         <span class="text-[10px] text-slate-300">Liquid</span>
                     </div>
                     <div onclick="selectTimerTheme('aurora')" id="theme-aurora" class="timer-theme-card min-w-[80px] p-2 rounded-lg border border-white/10 text-center flex flex-col items-center gap-2">
                         <div class="w-8 h-8 rounded bg-gradient-to-tr from-blue-500 to-purple-500"></div>
                         <span class="text-[10px] text-slate-300">Aurora</span>
                     </div>
                     <div onclick="selectTimerTheme('retro')" id="theme-retro" class="timer-theme-card min-w-[80px] p-2 rounded-lg border border-white/10 text-center flex flex-col items-center gap-2">
                         <div class="w-8 h-8 border-2 border-green-500 bg-black flex items-center justify-center"><div class="w-2 h-2 bg-green-500"></div></div>
                         <span class="text-[10px] text-slate-300">Retro</span>
                     </div>
                 </div>
            </div>
            
            <!-- Strict Mode Toggle -->
            <div class="mb-8 p-4 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center gap-3">
                <input type="checkbox" id="strictModeToggle" class="w-5 h-5 rounded border-red-400 text-red-500 focus:ring-red-500 bg-transparent accent-red-500 cursor-pointer">
                <div>
                    <label for="strictModeToggle" class="block text-sm font-bold text-red-200 cursor-pointer">Strict Focus Mode</label>
                    <p class="text-[10px] text-red-400/80">If you leave this app, the timer will pause immediately.</p>
                </div>
            </div>

            <button onclick="startSession()" class="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-slate-200 transition-all shadow-[0_0_20px_rgba(255,255,255,0.15)]">Begin Session</button>
        </div>
    </div>

    <!-- MAIN FOCUS INTERFACE -->
    <div id="focusMode" onmousemove="showControlsTemporary()" class="fixed inset-0 z-[100] hidden bg-[#030303] flex flex-col items-center justify-center transition-opacity duration-500 cursor-none">
        
        <!-- Background Ambient (Dynamic) -->
        <div id="focusAmbient" class="absolute inset-0 opacity-20 transition-colors duration-1000" style="background: radial-gradient(circle at center, var(--subject-color), transparent 70%);"></div>
        
        <!-- In-Focus Allowed Web Overlay -->
        <div id="inFocusWebOverlay" class="absolute inset-0 z-50 bg-black/80 backdrop-blur-md flex flex-col items-center justify-center hidden">
            <div class="glass-panel max-w-2xl w-full max-h-[80vh] rounded-3xl p-8 m-4 flex flex-col relative border-emerald-500/20">
                <button onclick="toggleInFocusWeb()" class="absolute top-4 right-4 text-slate-400 hover:text-white p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
                    <i class="fas fa-globe text-emerald-400"></i> Allowed Resources
                </h3>
                <p class="text-slate-400 text-sm mb-6">Open these links to study. (Strict Mode rules apply)</p>
                <div id="inFocusWebGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto custom-scrollbar p-1"></div>
            </div>
        </div>

        <div class="relative z-10 w-full max-w-md px-8 flex flex-col items-center">
            <div id="focusHeader" class="ui-visible mb-8 px-5 py-1.5 rounded-full border border-white/10 bg-white/5 backdrop-blur text-sm font-medium text-slate-200 tracking-wide flex items-center gap-2">
                <div id="focusSubjectDot" class="w-2 h-2 rounded-full bg-white"></div>
                <span id="focusSubjectName">Mathematics</span>
                <span id="focusModeBadge" class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-white/10 uppercase tracking-wider text-slate-400">Flow</span>
            </div>
            
            <!-- DYNAMIC TIMER CONTAINER -->
            <div id="timerContainer" class="w-full flex justify-center items-center mb-8">
                <!-- Theme Content Injected Here via JS -->
            </div>

            <div id="focusControls" class="ui-visible flex items-center gap-6 mt-4">
                <button onclick="togglePause()" id="pauseBtn" class="w-16 h-16 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 backdrop-blur flex items-center justify-center text-white transition-all hover:scale-105 active:scale-95 group"><i class="fas fa-pause text-xl group-hover:text-indigo-300"></i></button>
                <button onclick="stopTimer()" class="w-20 h-20 rounded-full bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 backdrop-blur flex items-center justify-center text-red-400 transition-all hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(239,68,68,0.2)]"><i class="fas fa-stop text-2xl"></i></button>
                <button onclick="toggleFullscreen()" class="w-16 h-16 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 backdrop-blur flex items-center justify-center text-white transition-all hover:scale-105 active:scale-95 group"><i class="fas fa-expand text-xl group-hover:text-indigo-300"></i></button>
                <button onclick="toggleInFocusWeb()" class="w-16 h-16 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 backdrop-blur flex items-center justify-center text-white transition-all hover:scale-105 active:scale-95 group relative">
                    <i class="fas fa-globe text-xl group-hover:text-emerald-300"></i>
                </button>
            </div>
            
            <div class="mt-12 h-20 flex items-center justify-center">
                <p id="motivationalQuote" class="text-center text-slate-400 text-lg md:text-xl max-w-lg leading-relaxed opacity-0 animate-fade-in font-bangla" style="animation-delay: 0.5s; animation-fill-mode: forwards;"></p>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- PRESETS ---
        // Expanded Color Palette
        const COLORS = [
            '#6366f1', '#ec4899', '#10b981', '#f59e0b', '#06b6d4', '#8b5cf6', 
            '#ef4444', '#f43f5e', '#3b82f6', '#14b8a6', '#84cc16', '#d946ef', 
            '#f97316', '#64748b', '#a855f7'
        ];

        const DAY_COLORS = ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#06b6d4', '#6366f1', '#a855f7'];
        const DEFAULT_AFFIRMATIONS = ["I am Focused", "Deep Work", "Flow State", "Absorbed", "Locked In", "Present"];
        const BREAK_AFFIRMATIONS = ["Breathe Deep", "Relax Eyes", "Stretch Now", "Neural Rest", "Recovery"];
        const BANGLA_QUOTES = ["          \n-  ", "       ,      \n-  ", "     ,     \n-  ", "    ,   \n-   ", "    ,     \n-  ", "    \n- ", "   - \n- ", "     ,     \n-  ", "        ?\n-  ", "   ,   \n- "];
        const ENGLISH_QUOTES = ["The only way to do great work is to love what you do.\n- Steve Jobs", "It does not matter how slowly you go as long as you do not stop.\n- Confucius", "Focus on being productive instead of busy.\n- Tim Ferriss", "The secret of getting ahead is getting started.\n- Mark Twain", "Believe you can and you're halfway there.\n- Theodore Roosevelt", "Action is the foundational key to all success.\n- Pablo Picasso", "Don't watch the clock; do what it does. Keep going.\n- Sam Levenson", "Success is sum of small efforts, repeated day in and day out.\n- Robert Collier"];
        const WEEKDAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- STUDY FLOW CONSTANTS ---
        const DEFAULT_COLUMNS = [
            "Online Class", "MCQ", "Theory", 
            "Academic Handnote", "Textbook Reading", 
            "Textbook Problems", "Board Test Solve"
        ];

        // --- THEME TEMPLATES ---
        const timerThemes = {
            orb: `
                <div class="zen-orb-container">
                    <div class="focus-tunnel"></div>
                    <div class="zen-heartbeat"></div>
                    <div class="zen-breath-ring"></div>
                    <div class="zen-orb flex flex-col items-center justify-center">
                        <div id="focusTimer" class="text-5xl font-mono font-bold tracking-tighter text-white drop-shadow-xl z-20">00:00:00</div>
                        <div id="focusAffirmation" class="text-xs text-indigo-100 font-bold uppercase tracking-widest mt-2 opacity-80 z-20 font-bangla">Flow State</div>
                    </div>
                </div>`,
            minimal: `
                <div class="theme-minimal-container">
                    <h1 id="focusTimer" class="text-7xl md:text-9xl font-black text-white tracking-tighter">00:00</h1>
                    <p id="focusAffirmation" class="text-xl md:text-2xl text-slate-500 uppercase tracking-[0.5em] mt-6 font-light">FOCUS</p>
                </div>`,
            cyber: `
                <div class="theme-cyber-container">
                    <div id="focusTimer" class="text-6xl md:text-8xl font-mono text-cyan-400 drop-shadow-[0_0_15px_rgba(6,182,212,0.8)]" style="text-shadow: 2px 2px 0px #ec4899;">00:00</div>
                    <p id="focusAffirmation" class="text-pink-500 font-bold mt-4 text-center text-lg font-mono">> STATUS: LOCKED_IN</p>
                </div>`,
            liquid: `
                <div class="theme-liquid-blob">
                    <div class="flex flex-col items-center">
                         <div id="focusTimer" class="text-5xl font-bold text-white relative z-10 drop-shadow-lg">00:00</div>
                         <div id="focusAffirmation" class="text-xs font-bold text-white/80 uppercase tracking-widest mt-1 relative z-10">Flowing</div>
                    </div>
                </div>`,
            aurora: `
                <div class="theme-aurora-bg"></div>
                <div class="flex flex-col items-center justify-center">
                     <div class="w-64 h-64 border border-white/20 rounded-full flex items-center justify-center backdrop-blur-sm bg-white/5">
                        <div id="focusTimer" class="text-5xl font-thin text-white tracking-widest">00:00</div>
                     </div>
                     <div id="focusAffirmation" class="text-sm text-slate-300 uppercase tracking-[0.3em] mt-8">Breathe</div>
                </div>`,
            retro: `
                <div class="theme-retro-box">
                    <div id="focusTimer" class="text-4xl md:text-5xl text-white mb-4">00:00</div>
                    <div id="focusAffirmation" class="text-xs text-green-400 uppercase leading-loose text-center">INSERT COIN<br>TO CONTINUE</div>
                </div>`
        };

        // --- SIDEBAR TOGGLE ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function navClick(view) {
            showView(view);
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        // --- STATE MANAGEMENT ---
        let state = { subjects: [], sessions: [], todos: [], todoHistory: {}, customMantras: [], routine: {}, events: [], allowedWebsites: [], activeTimer: null, tempSessionConfig: null, settings: { showQuotes: true, quoteLanguage: 'bangla' }, selectedRoutineDay: 'Monday' };
        
        // STUDY FLOW STATE
        let flowState = {
            subjects: [],
            currentSubjectId: null,
            editingSubjectId: null // Track which subject is being edited
        };

        let currentCalendarDate = new Date();
        let selectedCalendarDate = null;
        let focusBroken = false;
        let currentTheme = 'orb'; 

        const loadState = () => {
            const saved = localStorage.getItem('ypt_zen_v8'); 
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed }; 
                if(!state.subjects) state.subjects = [];
                if(!state.sessions) state.sessions = [];
                if(!state.todos) state.todos = [];
                if(!state.todoHistory) state.todoHistory = {};
                if(!state.customMantras) state.customMantras = [];
                if(!state.routine) state.routine = {};
                if(!state.events) state.events = [];
                if(!state.allowedWebsites) state.allowedWebsites = [];
                if(!state.settings) state.settings = { showQuotes: true, quoteLanguage: 'bangla' };
                WEEKDAYS.forEach(day => { if(!state.routine[day]) state.routine[day] = []; });
            } else {
                WEEKDAYS.forEach(day => { state.routine[day] = []; });
            }

            // Load Flow Data
            const flowSaved = localStorage.getItem('studyFlowSubjects');
            if (flowSaved) {
                flowState.subjects = JSON.parse(flowSaved);
            }

            // --- FEATURE 2: AUTO PURGE LOGIC ---
            const now = Date.now();
            const tenDaysMs = 10 * 24 * 60 * 60 * 1000;
            let purgedCount = 0;
            Object.keys(state.todoHistory).forEach(dateStr => {
                const dateObj = new Date(dateStr);
                if (!isNaN(dateObj.getTime())) {
                    if (now - dateObj.getTime() > tenDaysMs) {
                        delete state.todoHistory[dateStr];
                        purgedCount++;
                    }
                }
            });
            if(purgedCount > 0) saveState(); 
        };

        const saveState = () => {
            const { activeTimer, tempSessionConfig, ...dataToSave } = state;
            localStorage.setItem('ypt_zen_v8', JSON.stringify(dataToSave));
            updateSidebarStats();
        };

        const saveFlowData = () => {
            localStorage.setItem('studyFlowSubjects', JSON.stringify(flowState.subjects));
        };

        // --- TIMER & ROUTINE LOGIC ---
        class ZenTimer {
            constructor(config) { 
                this.subjectId = config.subjectId; 
                this.mode = config.mode; 
                this.strictMode = config.strictMode || false; 
                this.focusDuration = config.focusDuration * 60 * 1000; 
                this.breakDuration = config.breakDuration * 60 * 1000; 
                this.startTime = Date.now(); 
                this.phase = 'focus'; 
                this.phaseStartTime = this.startTime; 
                this.pausedTotal = 0; 
                this.pauseStart = null; 
                this.interval = null; 
                this.wakeLock = null; 
            }
            start() { 
                this.requestWakeLock(); 
                this.interval = setInterval(() => this.tick(), 100); 
                if(this.strictMode) {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(err => console.log(err));
                    }
                }
            }
            pause() { 
                if (this.pauseStart) { 
                    this.pausedTotal += Date.now() - this.pauseStart; 
                    this.pauseStart = null; 
                    const ring = document.querySelector('.zen-breath-ring');
                    if(ring) ring.style.animationPlayState = 'running'; 
                    if(this.strictMode && document.fullscreenElement === null) {
                         if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen().catch(e=>console.log(e));
                        }
                    }
                } else { 
                    this.pauseStart = Date.now(); 
                    const ring = document.querySelector('.zen-breath-ring');
                    if(ring) ring.style.animationPlayState = 'paused'; 
                } 
                this.updateUI(); 
            }
            stop() { 
                clearInterval(this.interval); 
                this.releaseWakeLock(); 
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => console.log(err));
                }
                let totalFocusTime = 0; 
                const now = Date.now(); 
                if (this.mode === 'flow') { 
                    totalFocusTime = Math.floor((now - this.startTime - this.pausedTotal) / 1000); 
                } else { 
                    if (this.phase === 'focus') { 
                        totalFocusTime = Math.floor((now - this.phaseStartTime - this.pausedTotal) / 1000); 
                    } else { 
                        totalFocusTime = this.focusDuration / 1000; 
                    } 
                } 
                return totalFocusTime > 0 ? totalFocusTime : 0; 
            }
            tick() { 
                if (this.pauseStart) return; 
                const now = Date.now(); 
                const timerEl = document.getElementById('focusTimer');
                const affirmEl = document.getElementById('focusAffirmation');
                
                if (this.mode === 'flow') { 
                    const diff = Math.floor((now - this.startTime - this.pausedTotal) / 1000); 
                    if(timerEl) timerEl.innerText = formatTime(diff); 
                    this.updateAffirmation(diff); 
                } else { 
                    const elapsedInPhase = now - this.phaseStartTime - this.pausedTotal; 
                    const targetDuration = this.phase === 'focus' ? this.focusDuration : this.breakDuration; 
                    const remaining = Math.ceil((targetDuration - elapsedInPhase) / 1000); 
                    if (remaining <= 0) { 
                        this.switchPhase(); 
                    } else { 
                        if(timerEl) timerEl.innerText = formatTime(remaining); 
                        const list = this.phase === 'focus' ? [...DEFAULT_AFFIRMATIONS, ...state.customMantras] : BREAK_AFFIRMATIONS; 
                        const idx = Math.floor((elapsedInPhase / 1000 / 30) % list.length); 
                        if(affirmEl) affirmEl.innerText = list[idx]; 
                    } 
                } 
                const subject = state.subjects.find(s => s.id === this.subjectId); 
                const prefix = this.phase === 'break' ? '' : ''; 
                const timeText = timerEl ? timerEl.innerText : 'Focus'; 
                document.title = `${prefix} ${timeText}  Focus Space`; 
            }
            updateAffirmation(diff) { 
                const affirmEl = document.getElementById('focusAffirmation');
                if (diff > 0 && diff % 30 === 0 && diff % 1 === 0 && affirmEl) { 
                    const allMantras = [...DEFAULT_AFFIRMATIONS, ...state.customMantras]; 
                    const idx = Math.floor((diff / 30) % allMantras.length); 
                    affirmEl.innerText = allMantras[idx]; 
                } 
            }
            switchPhase() { 
                this.pausedTotal = 0; 
                this.phaseStartTime = Date.now(); 
                const affirmEl = document.getElementById('focusAffirmation');
                const badgeEl = document.getElementById('focusModeBadge');
                
                if (this.phase === 'focus') { 
                    this.phase = 'break'; 
                    document.documentElement.style.setProperty('--subject-color', '#10b981'); 
                    if(affirmEl) affirmEl.innerText = "RESTORE"; 
                    if(badgeEl) {
                        badgeEl.innerText = "RECOVERY"; 
                        badgeEl.classList.replace('text-slate-400', 'text-teal-400'); 
                    }
                    const orb = document.querySelector('.zen-orb');
                    if(orb) orb.style.animationDuration = '10s'; 
                } else { 
                    this.phase = 'focus'; 
                    const sub = state.subjects.find(s => s.id === this.subjectId); 
                    document.documentElement.style.setProperty('--subject-color', sub.color); 
                    if(affirmEl) affirmEl.innerText = "FOCUS"; 
                    if(badgeEl) {
                        badgeEl.innerText = "CYCLE"; 
                        badgeEl.classList.replace('text-teal-400', 'text-slate-400'); 
                    }
                    const orb = document.querySelector('.zen-orb');
                    if(orb) orb.style.animationDuration = '6s'; 
                } 
            }
            updateUI() { 
                const btn = document.getElementById('pauseBtn'); 
                if (this.pauseStart) { btn.innerHTML = '<i class="fas fa-play"></i>'; } else { btn.innerHTML = '<i class="fas fa-pause"></i>'; } 
            }
            async requestWakeLock() { try { if ('wakeLock' in navigator) this.wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { console.log('Wake Lock Error', e); } }
            async releaseWakeLock() { if (this.wakeLock) await this.wakeLock.release(); }
        }

        // --- CALENDAR DRILL-DOWN ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('currentMonthLabel').innerText = `${MONTHS[month]} ${year}`;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay(); 
            const daysInMonth = lastDay.getDate();

            for(let i=0; i<startingDay; i++) {
                grid.innerHTML += '<div></div>';
            }

            const today = new Date();
            for(let i=1; i<=daysInMonth; i++) {
                const date = new Date(year, month, i);
                const isToday = date.toDateString() === today.toDateString();
                const dayOfWeek = date.getDay();
                const isWeekend = (dayOfWeek === 5 || dayOfWeek === 6);
                
                const eventsForDay = state.events.filter(e => {
                    const eDate = new Date(e.date);
                    return eDate.getDate() === i && eDate.getMonth() === month && eDate.getFullYear() === year;
                });

                const div = document.createElement('div');
                div.className = `calendar-day ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}`;
                
                let eventsHtml = '';
                eventsForDay.forEach(e => {
                    eventsHtml += `<div class="calendar-event-tag">${e.title}</div>`;
                });

                div.innerHTML = `<span class="calendar-date-number ${isWeekend ? 'text-red-400' : 'text-slate-300'}">${i}</span>${eventsHtml}`;
                div.onclick = () => openDayView(date); 
                grid.appendChild(div);
            }
        }

        function changeMonth(delta) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta); renderCalendar(); }
        
        function openAddEventModal(date) {
            selectedCalendarDate = date;
            document.getElementById('addEventModal').classList.remove('hidden');
            document.getElementById('eventModalDateLabel').innerText = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('eventTitle').value = '';
            const list = document.getElementById('existingEventsList');
            const eventsForDay = state.events.filter(e => {
                const eDate = new Date(e.date);
                return eDate.toDateString() === date.toDateString();
            });
            if (eventsForDay.length === 0) {
                list.innerHTML = '<p class="text-xs text-slate-500 italic">No events scheduled.</p>';
            } else {
                list.innerHTML = eventsForDay.map(e => `<div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition-colors"><span class="text-sm text-white truncate font-medium">${e.title}</span><button onclick="deleteEvent('${e.id}')" class="text-red-400 hover:text-red-300 px-3 py-1 rounded bg-red-500/10 hover:bg-red-500/20 text-xs font-bold uppercase transition-colors">Delete</button></div>`).join('');
            }
        }
        function deleteEvent(id) {
            if(!confirm("Delete this event?")) return;
            state.events = state.events.filter(e => e.id !== id);
            saveState();
            if (selectedCalendarDate) openAddEventModal(selectedCalendarDate);
            renderCalendar();
            renderUpcomingEvents();
        }
        function closeAddEventModal() { document.getElementById('addEventModal').classList.add('hidden'); selectedCalendarDate = null; }
        function addEvent() {
            const title = document.getElementById('eventTitle').value;
            const time = document.getElementById('eventTime').value;
            if(!title || !selectedCalendarDate) return;
            const [hours, mins] = time.split(':');
            selectedCalendarDate.setHours(parseInt(hours), parseInt(mins));
            state.events.push({ id: crypto.randomUUID(), title: title, date: selectedCalendarDate.getTime() });
            saveState();
            openAddEventModal(selectedCalendarDate); 
            renderCalendar();
            renderUpcomingEvents();
        }

        // --- UPDATED: DAY VIEW FUNCTION (SMARTER DESIGN) ---
        function openDayView(date) {
            selectedCalendarDate = date;
            const modal = document.getElementById('dayViewModal');
            const dateStr = date.toDateString();
            
            document.getElementById('dayViewTitle').innerText = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            // 1. Get Sessions for this day
            const sessionsForDay = state.sessions.filter(s => new Date(s.startTime).toDateString() === dateStr);
            const totalTime = sessionsForDay.reduce((acc, s) => acc + s.duration, 0);
            
            document.getElementById('dayViewTotalTime').innerText = formatTime(totalTime);

            // 2. Render Sessions List (Timeline Style)
            const sessionsContainer = document.getElementById('dayViewSessions');
            if(sessionsForDay.length === 0) {
                sessionsContainer.innerHTML = '<div class="text-center py-8 border-2 border-dashed border-white/5 rounded-xl text-slate-600 text-sm italic"><p>No sessions recorded.</p></div>';
            } else {
                sessionsContainer.innerHTML = sessionsForDay.map((s, i) => {
                    const sub = state.subjects.find(sub => sub.id === s.subjectId);
                    const timeStr = new Date(s.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    return `
                    <div class="session-timeline-item animate-slide-up" style="animation-delay: ${i * 100}ms">
                        <div class="session-timeline-dot" style="color: ${sub ? sub.color : '#555'}"></div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-bold text-white">${sub ? sub.name : 'Unknown'}</span>
                            <span class="text-xs text-slate-500 font-mono">${timeStr}</span>
                        </div>
                        <div class="text-xs text-slate-400 pl-1">${formatTime(s.duration)}</div>
                    </div>`;
                }).join('');
            }

            // 3. Render To-Dos for this day (Efficiency Ring)
            const todosContainer = document.getElementById('dayViewTasks');
            const todosForDay = state.todoHistory[dateStr];
            
            if (!todosForDay || todosForDay.length === 0) {
                todosContainer.innerHTML = '<p class="text-slate-500 text-xs italic py-2 text-center">No tasks recorded.</p>';
                // Update Ring
                document.getElementById('dayEfficiencyRing').style.setProperty('--percent', '0%');
                document.getElementById('dayEfficiencyScore').innerText = '0%';
            } else {
                const completedCount = todosForDay.filter(t => t.done).length;
                const totalCount = todosForDay.length;
                const efficiency = Math.round((completedCount / totalCount) * 100);
                
                // Update Ring
                document.getElementById('dayEfficiencyRing').style.setProperty('--percent', `${efficiency}%`);
                document.getElementById('dayEfficiencyScore').innerText = `${efficiency}%`;

                todosContainer.innerHTML = todosForDay.map(t => `
                    <div class="flex items-center gap-3 p-2.5 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 transition-all group">
                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center shrink-0 ${t.done ? 'border-green-500 bg-green-500/20' : 'border-slate-500 bg-transparent'}">
                            ${t.done ? '<i class="fas fa-check text-green-500 text-[10px]"></i>' : ''}
                        </div>
                        <span class="text-sm ${t.done ? 'line-through text-slate-500' : 'text-slate-200'} truncate flex-1">${t.text}</span>
                    </div>
                `).join('');
            }

            modal.classList.remove('hidden');
        }

        function closeDayView() {
            document.getElementById('dayViewModal').classList.add('hidden');
        }

        function renderUpcomingEvents() {
            const container = document.getElementById('upcomingEventsContainer');
            const now = Date.now();
            const upcoming = state.events.filter(e => e.date > now).sort((a, b) => a.date - b.date).slice(0, 3);
            if(upcoming.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            container.innerHTML = `<h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="fas fa-hourglass-start text-indigo-400"></i> Upcoming Deadlines</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4">${upcoming.map(e => {
                const diff = e.date - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const eventDate = new Date(e.date);
                return `<div class="glass-card countdown-card p-4 rounded-xl relative overflow-hidden"><h4 class="font-bold text-white text-lg truncate">${e.title}</h4><p class="text-xs text-slate-400 mb-3">${eventDate.toLocaleDateString()} at ${eventDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p><div class="flex items-baseline gap-2"><span class="text-2xl font-mono font-bold text-white">${days}</span><span class="text-xs text-slate-400">Days</span><span class="text-xl font-mono font-bold text-indigo-300">:</span><span class="text-2xl font-mono font-bold text-white">${hours}</span><span class="text-xs text-slate-400">Hours</span></div></div>`;
            }).join('')}</div>`;
        }
        
        // --- ALLOWED WEB PORTAL ---
        function renderAllowedSites() {
            const grid = document.getElementById('allowedWebGrid');
            const empty = document.getElementById('emptyWebState');
            if (!state.allowedWebsites || state.allowedWebsites.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');
            grid.innerHTML = state.allowedWebsites.map(site => {
                const iconUrl = `https://www.google.com/s2/favicons?domain=${site.url}&sz=64`;
                return `<div class="glass-card p-4 rounded-xl flex items-center gap-4 relative group hover:bg-white/5 transition-colors"><div class="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center overflow-hidden shrink-0"><img src="${iconUrl}" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/globe.svg'" alt="icon" class="w-8 h-8 object-contain"></div><div class="flex-1 min-w-0"><h4 class="font-bold text-white text-base truncate">${site.title}</h4><a href="${site.url}" target="_blank" rel="noopener noreferrer" class="text-xs text-emerald-400 hover:underline truncate block">${site.url}</a></div><button onclick="deleteAllowedSite('${site.id}')" class="absolute top-2 right-2 text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-2"><i class="fas fa-trash-alt"></i></button><a href="${site.url}" target="_blank" rel="noopener noreferrer" class="absolute inset-0 z-0"></a></div>`;
            }).join('');
        }
        function openAddWebModal() { document.getElementById('addWebModal').classList.remove('hidden'); }
        function closeAddWebModal() { document.getElementById('addWebModal').classList.add('hidden'); document.getElementById('webTitle').value = ''; document.getElementById('webUrl').value = ''; }
        function addWebsite() {
            const title = document.getElementById('webTitle').value.trim();
            let url = document.getElementById('webUrl').value.trim();
            if (!title || !url) return;
            if (!url.startsWith('http://') && !url.startsWith('https://')) { url = 'https://' + url; }
            state.allowedWebsites.push({ id: crypto.randomUUID(), title: title, url: url });
            saveState();
            renderAllowedSites();
            closeAddWebModal();
        }
        function deleteAllowedSite(id) { if(confirm("Remove this allowed site?")) { state.allowedWebsites = state.allowedWebsites.filter(s => s.id !== id); saveState(); renderAllowedSites(); } }
        
        function toggleInFocusWeb() {
            const overlay = document.getElementById('inFocusWebOverlay');
            overlay.classList.toggle('hidden');
            if (!overlay.classList.contains('hidden')) {
                const grid = document.getElementById('inFocusWebGrid');
                if (!state.allowedWebsites || state.allowedWebsites.length === 0) {
                    grid.innerHTML = '<p class="text-slate-500 italic text-sm text-center col-span-2 py-4">No allowed sites configured. Go to "Study Web" to add some.</p>';
                    return;
                }
                grid.innerHTML = state.allowedWebsites.map(site => {
                    const iconUrl = `https://www.google.com/s2/favicons?domain=${site.url}&sz=64`;
                    return `<a href="${site.url}" target="_blank" rel="noopener noreferrer" class="glass-card p-3 rounded-xl flex items-center gap-3 hover:bg-white/10 transition-colors"><div class="w-8 h-8 rounded-md bg-white/10 flex items-center justify-center overflow-hidden shrink-0"><img src="${iconUrl}" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/globe.svg'" alt="icon" class="w-5 h-5 object-contain"></div><div class="min-w-0"><h4 class="font-bold text-white text-sm truncate">${site.title}</h4><p class="text-[10px] text-emerald-400 truncate">${site.url}</p></div></a>`;
                }).join('');
            }
        }

        // --- UTILS & INITIALIZATION ---
        function renderSubjects() { const grid = document.getElementById('subjectsGrid'); const empty = document.getElementById('emptyState'); if (state.subjects.length === 0) { grid.innerHTML = ''; empty.classList.remove('hidden'); return; } empty.classList.add('hidden'); grid.innerHTML = state.subjects.map(sub => `<div class="glass-card rounded-2xl p-6 relative overflow-hidden group"><div class="absolute top-0 left-0 w-1 h-full" style="background: ${sub.color}"></div><div class="flex justify-between items-start mb-4"><div class="flex items-center gap-3"><div class="color-dot" style="--color: ${sub.color}"></div><h3 class="font-bold text-lg text-slate-200 group-hover:text-white transition-colors">${sub.name}</h3></div><button onclick="deleteSubject('${sub.id}')" class="text-slate-600 hover:text-red-400 transition-colors px-2"><i class="fas fa-trash-alt"></i></button></div><div class="flex items-end justify-between mt-6"><div><p class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Today</p><p class="text-3xl font-mono text-white tracking-tight">${formatTime(sub.totalTimeToday)}</p></div><button onclick="openSessionSetup('${sub.id}')" class="w-12 h-12 rounded-full bg-white/5 hover:bg-white text-white hover:text-black flex items-center justify-center transition-all hover:scale-110 shadow-lg border border-white/10 hover:border-white"><i class="fas fa-play ml-1"></i></button></div></div>`).join(''); }
        function renderTodos() { const list = document.getElementById('todoList'); const empty = document.getElementById('emptyTodo'); if (state.todos.length === 0) { list.innerHTML = ''; empty.classList.remove('hidden'); return; } empty.classList.add('hidden'); list.innerHTML = state.todos.map(todo => `<div class="flex items-center gap-3 p-3 bg-white/5 rounded-xl border border-white/5 hover:border-white/20 transition-all group"><label class="custom-checkbox flex items-center cursor-pointer relative"><input type="checkbox" class="sr-only" ${todo.done ? 'checked' : ''} onchange="toggleTodo('${todo.id}')"><div class="w-5 h-5 border-2 border-slate-500 rounded-md transition-colors flex items-center justify-center" style="--checked-color: #6366f1"><svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div></label><span class="flex-1 text-sm ${todo.done ? 'line-through text-slate-500' : 'text-slate-200'}">${todo.text}</span><button onclick="deleteTodo('${todo.id}')" class="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all"><i class="fas fa-times"></i></button></div>`).join(''); }
        function addTodo() { const input = document.getElementById('todoInput'); const text = input.value.trim(); if (!text) return; state.todos.push({ id: crypto.randomUUID(), text, done: false }); input.value = ''; saveState(); renderTodos(); renderWeeklyHistory(); }
        function toggleTodo(id) { const todo = state.todos.find(t => t.id === id); if (todo) todo.done = !todo.done; saveState(); renderTodos(); renderWeeklyHistory(); }
        function deleteTodo(id) { state.todos = state.todos.filter(t => t.id !== id); saveState(); renderTodos(); renderWeeklyHistory(); }
        function renderWeeklyHistory() { const container = document.getElementById('weeklyLogList'); if(!container) return; let html = '<div class="timeline-line"></div>'; for(let i = 0; i < 7; i++) { const d = new Date(); d.setDate(d.getDate() - i); const dateKey = d.toDateString(); const isToday = i === 0; const dayName = isToday ? "Today" : d.toLocaleDateString('en-US', { weekday: 'long' }); const dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); const color = DAY_COLORS[d.getDay()]; let todosForDay = isToday ? state.todos : (state.todoHistory[dateKey] || []); if (todosForDay.length === 0 && !isToday) continue; const completedCount = todosForDay.filter(t => t.done).length; const totalCount = todosForDay.length; let itemsHtml = todosForDay.length === 0 ? '<p class="text-xs text-slate-500 italic">No tasks added.</p>' : todosForDay.map(t => `<div class="flex items-center gap-2 mb-1"><div class="w-1.5 h-1.5 rounded-full ${t.done ? 'bg-slate-500' : 'bg-white'}"></div><span class="text-xs ${t.done ? 'line-through text-slate-500' : 'text-slate-300'} truncate">${t.text}</span></div>`).join(''); html += `<div class="timeline-item"><div class="timeline-dot" style="--day-color: ${color}"></div><div class="day-header" style="--day-color: ${color}"><span>${dayName}</span><span class="text-slate-600 font-normal text-[10px] bg-white/5 px-1.5 py-0.5 rounded">${dateDisplay}</span></div><div class="history-card" style="--day-color: ${color}"><div class="flex justify-between items-center mb-2"><span class="text-[10px] text-slate-400 font-mono tracking-wider">PROGRESS</span><span class="text-[10px] font-bold ${completedCount === totalCount && totalCount > 0 ? 'text-green-400' : 'text-slate-300'}">${completedCount}/${totalCount}</span></div><div class="max-h-24 overflow-y-auto pr-1 custom-scrollbar">${itemsHtml}</div></div></div>`; } container.innerHTML = html; }
        
        function renderRoutineView() { const selector = document.getElementById('daySelector'); selector.innerHTML = WEEKDAYS.map(day => `<button onclick="selectRoutineDay('${day}')" class="day-tab px-6 py-3 rounded-xl border border-white/5 whitespace-nowrap text-sm font-medium ${state.selectedRoutineDay === day ? 'active-day' : 'text-slate-400 hover:bg-white/5'}">${day}</button>`).join(''); document.getElementById('selectedDayLabel').innerText = state.selectedRoutineDay; const select = document.getElementById('routineSubjectSelect'); select.innerHTML = state.subjects.length ? state.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('') : '<option disabled>Create a Subject first</option>'; const listContainer = document.getElementById('routineListForDay'); const emptyState = document.getElementById('emptyRoutine'); const currentRoutine = state.routine[state.selectedRoutineDay] || []; if (currentRoutine.length === 0) { listContainer.innerHTML = ''; emptyState.classList.remove('hidden'); } else { emptyState.classList.add('hidden'); listContainer.innerHTML = currentRoutine.map((item, index) => { const subject = state.subjects.find(s => s.id === item.subjectId); if (!subject) return ''; return `<div class="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5 hover:border-white/10 transition-colors"><div class="flex items-center gap-4"><div class="w-2 h-2 rounded-full" style="background:${subject.color}"></div><div><p class="font-bold text-white">${subject.name}</p><p class="text-xs text-slate-500">Target: ${item.targetTime} minutes</p></div></div><button onclick="removeFromRoutine(${index})" class="text-slate-600 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button></div>`; }).join(''); } }
        function selectRoutineDay(day) { state.selectedRoutineDay = day; renderRoutineView(); }
        function addToRoutine() { const subjectId = document.getElementById('routineSubjectSelect').value; const targetTime = parseInt(document.getElementById('routineTargetTime').value); if(!subjectId || !targetTime || targetTime <= 0) return; const existing = state.routine[state.selectedRoutineDay].find(i => i.subjectId === subjectId); if(existing) { existing.targetTime = targetTime; } else { state.routine[state.selectedRoutineDay].push({ subjectId, targetTime }); } document.getElementById('routineTargetTime').value = ''; saveState(); renderRoutineView(); renderDailyGoals(); }
        function removeFromRoutine(index) { state.routine[state.selectedRoutineDay].splice(index, 1); saveState(); renderRoutineView(); renderDailyGoals(); }
        function renderDailyGoals() { const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' }); const todaysRoutine = state.routine[todayName] || []; const container = document.getElementById('todaysGoalsContainer'); const section = document.getElementById('todaysGoalsSection'); if (todaysRoutine.length === 0) { section.classList.add('hidden'); return; } section.classList.remove('hidden'); container.innerHTML = todaysRoutine.map(item => { const subject = state.subjects.find(s => s.id === item.subjectId); if (!subject) return ''; const actualMinutes = Math.floor(subject.totalTimeToday / 60); const targetMinutes = item.targetTime; const percentage = Math.min(100, (actualMinutes / targetMinutes) * 100); return `<div class="glass-card p-4 rounded-xl flex flex-col justify-between relative overflow-hidden group"><div class="absolute bottom-0 left-0 h-1 bg-white/10 w-full"><div class="h-full transition-all duration-1000" style="width: ${percentage}%; background-color: ${subject.color}"></div></div><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-white text-sm">${subject.name}</h4><span class="text-[10px] text-slate-400 uppercase tracking-wide">Goal</span></div><div class="flex items-end justify-between"><div><span class="text-2xl font-mono font-bold text-white">${actualMinutes}</span><span class="text-xs text-slate-500">/${targetMinutes}m</span></div><button onclick="openSessionSetup('${subject.id}')" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white text-white hover:text-black flex items-center justify-center transition-all opacity-0 group-hover:opacity-100"><i class="fas fa-play text-xs"></i></button></div></div>`; }).join(''); }

        function renderMantras() { const list = document.getElementById('mantraList'); if (state.customMantras.length === 0) { list.innerHTML = '<p class="text-slate-500 text-xs italic">No custom mantras added yet.</p>'; } else { list.innerHTML = state.customMantras.map((m, index) => `<div class="flex items-center justify-between p-2 bg-white/5 rounded-lg"><span class="text-sm text-slate-300 font-bangla">"${m}"</span><button onclick="deleteMantra(${index})" class="text-slate-500 hover:text-red-400"><i class="fas fa-trash text-xs"></i></button></div>`).join(''); } document.getElementById('showQuotesToggle').checked = state.settings.showQuotes; document.getElementById('quoteLanguageSelect').value = state.settings.quoteLanguage; const langOption = document.getElementById('quoteLanguageOption'); if (state.settings.showQuotes) { langOption.classList.remove('opacity-50', 'pointer-events-none'); } else { langOption.classList.add('opacity-50', 'pointer-events-none'); } }
        function toggleQuotesSetting() { state.settings.showQuotes = document.getElementById('showQuotesToggle').checked; saveState(); renderMantras(); }
        function changeQuoteLanguage() { state.settings.quoteLanguage = document.getElementById('quoteLanguageSelect').value; saveState(); }
        function addMantra() { const input = document.getElementById('newMantraInput'); const val = input.value.trim(); if (!val) return; state.customMantras.push(val); input.value = ''; saveState(); renderMantras(); }
        function deleteMantra(index) { state.customMantras.splice(index, 1); saveState(); renderMantras(); }
        function formatTime(s) { const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = s % 60; return `${pad(h)}:${pad(m)}:${pad(sec)}`; }
        const pad = (n) => n.toString().padStart(2, '0');
        function updateSidebarStats() { const total = state.subjects.reduce((acc, cur) => acc + cur.totalTimeToday, 0); document.getElementById('sidebarTotalTime').innerText = formatTime(total); const pct = Math.min(100, Math.round((total / 14400) * 100)); document.getElementById('totalProgressBar').style.width = `${pct}%`; document.getElementById('progressPercent').innerText = `${pct}%`; }
        function addSubject() { const name = document.getElementById('subjectName').value.trim(); const color = document.getElementById('selectedColor').value; if (!name) return; state.subjects.push({ id: crypto.randomUUID(), name, color, totalTimeToday: 0 }); saveState(); renderSubjects(); closeAddSubjectModal(); renderRoutineView(); }
        function deleteSubject(id) { if(confirm("Delete this subject?")) { state.subjects = state.subjects.filter(s => s.id !== id); saveState(); renderSubjects(); renderRoutineView(); renderDailyGoals(); } }
        function showView(view) { document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); document.getElementById(view + 'View').classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById('nav-' + view)?.classList.add('active'); if (view === 'analytics') renderAnalytics(); if (view === 'settings') renderMantras(); if(view === 'routine') renderRoutineView(); if(view === 'calendar') renderCalendar(); if(view === 'web') renderAllowedSites(); if(view === 'tasks') renderWeeklyHistory(); if(view === 'flow') { showFlowDashboard(); } }
        function openAddSubjectModal() { document.getElementById('addSubjectModal').classList.remove('hidden'); document.getElementById('colorPicker').innerHTML = COLORS.map(c => `<div onclick="selectColor('${c}')" class="w-8 h-8 rounded-full cursor-pointer hover:scale-110 transition-transform ring-2 ring-offset-2 ring-offset-black ${c === document.getElementById('selectedColor').value ? 'ring-white' : 'ring-transparent'}" style="background: ${c}"></div>`).join(''); }
        function selectColor(c) { document.getElementById('selectedColor').value = c; openAddSubjectModal(); }
        function closeAddSubjectModal() { document.getElementById('addSubjectModal').classList.add('hidden'); document.getElementById('subjectName').value = ''; }
        function openSessionSetup(subjectId) { 
            state.tempSessionConfig = { subjectId: subjectId, mode: 'flow', focusDuration: 25, breakDuration: 5 }; 
            document.getElementById('sessionSetupModal').classList.remove('hidden'); 
            selectSessionMode('flow'); 
            selectTimerTheme('orb'); 
            updateRangeDisplays(); 
            document.getElementById('strictModeToggle').checked = false; 
        }
        function closeSessionSetup() { document.getElementById('sessionSetupModal').classList.add('hidden'); }
        function selectSessionMode(mode) { state.tempSessionConfig.mode = mode; const flowCard = document.getElementById('modeFlow'); const cycleCard = document.getElementById('modeCycle'); const settings = document.getElementById('cycleSettings'); if (mode === 'flow') { flowCard.classList.add('selected'); cycleCard.classList.remove('selected'); settings.classList.add('hidden'); } else { flowCard.classList.remove('selected'); cycleCard.classList.add('selected'); settings.classList.remove('hidden'); } }
        
        function selectTimerTheme(theme) {
            currentTheme = theme;
            document.querySelectorAll('.timer-theme-card').forEach(c => c.classList.remove('selected', 'bg-white/10'));
            const selectedCard = document.getElementById(`theme-${theme}`);
            if(selectedCard) {
                selectedCard.classList.add('selected', 'bg-white/10');
            }
        }
        
        function updateRangeDisplays() { const focusVal = document.getElementById('focusSlider').value; const breakVal = document.getElementById('breakSlider').value; document.getElementById('focusTimeDisplay').innerText = `${focusVal} min`; document.getElementById('breakTimeDisplay').innerText = `${breakVal} min`; if(state.tempSessionConfig) { state.tempSessionConfig.focusDuration = parseInt(focusVal); state.tempSessionConfig.breakDuration = parseInt(breakVal); } }
        function initiateFocusSequence(id) { const overlay = document.getElementById('prepOverlay'); const countEl = document.getElementById('prepCount'); const textEl = document.getElementById('prepText'); overlay.classList.add('prep-active'); countEl.innerText = "3"; textEl.innerText = "Breathe In"; setTimeout(() => { countEl.innerText = "2"; textEl.innerText = "Hold & Focus"; }, 1500); setTimeout(() => { countEl.innerText = "1"; textEl.innerText = "Release"; }, 3000); setTimeout(() => { overlay.classList.remove('prep-active'); startTimer(id); }, 4500); }
        function startTimer(id) { 
            const sub = state.subjects.find(s => s.id === id); 
            if (!sub) return; 
            const config = state.tempSessionConfig || { subjectId: id, mode: 'flow' }; 
            const container = document.getElementById('timerContainer');
            container.innerHTML = timerThemes[currentTheme] || timerThemes['orb'];
            state.activeTimer = new ZenTimer(config); 
            state.activeTimer.start(); 
            document.documentElement.style.setProperty('--subject-color', sub.color); 
            document.getElementById('focusSubjectName').innerText = sub.name; 
            document.getElementById('focusSubjectDot').style.backgroundColor = sub.color; 
            document.getElementById('focusMode').classList.remove('hidden'); 
            const badge = document.getElementById('focusModeBadge'); 
            if (config.mode === 'flow') { 
                document.getElementById('focusTimer').innerText = "00:00:00"; 
                if(badge) badge.innerText = "FLOW STATE"; 
            } else { 
                document.getElementById('focusTimer').innerText = formatTime(config.focusDuration * 60); 
                if(badge) badge.innerText = "COGNITIVE CYCLE"; 
            } 
            const allMantras = [...DEFAULT_AFFIRMATIONS, ...state.customMantras]; 
            const affirmEl = document.getElementById('focusAffirmation');
            if(affirmEl) affirmEl.innerText = allMantras[0]; 
            resetControlTimer(); 
            const quoteEl = document.getElementById('motivationalQuote'); 
            if (!state.settings.showQuotes) { 
                quoteEl.classList.add('hidden'); 
            } else { 
                quoteEl.classList.remove('hidden'); 
                let quoteText = ""; 
                if (state.customMantras && state.customMantras.length > 0) { 
                    quoteText = state.customMantras[Math.floor(Math.random() * state.customMantras.length)]; 
                } else { 
                    const lang = state.settings.quoteLanguage; 
                    const pool = lang === 'english' ? ENGLISH_QUOTES : BANGLA_QUOTES; 
                    quoteText = pool[Math.floor(Math.random() * pool.length)]; 
                } 
                quoteEl.innerText = quoteText; 
                quoteEl.classList.remove('animate-fade-in'); 
                void quoteEl.offsetWidth; 
                quoteEl.classList.add('animate-fade-in'); 
            } 
        }
        function startSession() { 
            state.tempSessionConfig.strictMode = document.getElementById('strictModeToggle').checked; 
            closeSessionSetup(); 
            initiateFocusSequence(state.tempSessionConfig.subjectId); 
        }
        function stopTimer() { 
            if (!state.activeTimer) return; 
            const duration = state.activeTimer.stop(); 
            const subId = state.activeTimer.subjectId; 
            if (duration > 0) { 
                const sub = state.subjects.find(s => s.id === subId); 
                sub.totalTimeToday += duration; 
                state.sessions.push({ id: Date.now(), subjectId: subId, startTime: state.activeTimer.startTime, duration: duration }); 
                saveState(); 
            } 
            state.activeTimer = null; 
            document.getElementById('focusMode').classList.add('hidden'); 
            document.getElementById('focusMode').classList.remove('cursor-none'); 
            document.getElementById('focusControls').classList.replace('ui-faded', 'ui-visible'); 
            document.getElementById('inFocusWebOverlay').classList.add('hidden');
            document.title = "Focus Space"; 
            renderSubjects(); 
            renderDailyGoals(); 
            if (document.fullscreenElement) {
                document.exitFullscreen().catch(err => console.log(err));
            }
        }
        function togglePause() { if (state.activeTimer) state.activeTimer.pause(); }
        function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => console.warn("Fullscreen blocked by browser policy")); } else { if (document.exitFullscreen) document.exitFullscreen(); } }
        let controlTimeout; function showControlsTemporary() { const controls = document.getElementById('focusControls'); const header = document.getElementById('focusHeader'); const container = document.getElementById('focusMode'); controls.classList.remove('ui-faded'); controls.classList.add('ui-visible'); header.classList.remove('ui-faded'); header.classList.add('ui-visible'); container.classList.remove('cursor-none'); resetControlTimer(); }
        function resetControlTimer() { clearTimeout(controlTimeout); controlTimeout = setTimeout(() => { if (state.activeTimer && !state.activeTimer.pauseStart) { document.getElementById('focusControls').classList.replace('ui-visible', 'ui-faded'); document.getElementById('focusHeader').classList.replace('ui-visible', 'ui-faded'); document.getElementById('focusMode').classList.add('cursor-none'); } }, 3000); }
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `focus_space_${new Date().toISOString().slice(0,10)}.json`); dl.click(); }
        function clearData() { if(confirm("Reset EVERYTHING? This cannot be undone.")) { localStorage.removeItem('ypt_zen_v8'); location.reload(); } }
        
        let charts = {}; 
        
        // --- UPDATED ANALYTICS SYSTEM (SMARTER DESIGN) ---
        let analyticsFilter = '7d'; 

        function setAnalyticsFilter(type) {
            analyticsFilter = type;
            const btn7 = document.getElementById('btn-filter-7d');
            const btn30 = document.getElementById('btn-filter-30d');
            const dateInput = document.getElementById('customDateInput');

            // Reset UI
            btn7.classList.remove('bg-indigo-600', 'text-white');
            btn7.classList.add('text-slate-400');
            btn30.classList.remove('bg-indigo-600', 'text-white');
            btn30.classList.add('text-slate-400');

            if(type === '7d') {
                btn7.classList.add('bg-indigo-600', 'text-white');
                btn7.classList.remove('text-slate-400');
                dateInput.value = '';
            } else if (type === '30d') {
                btn30.classList.add('bg-indigo-600', 'text-white');
                btn30.classList.remove('text-slate-400');
                dateInput.value = '';
            } else {
                // Custom date logic handled by change event
            }

            renderAnalytics();
        }

        function getFilteredSessions() {
            const now = Date.now();
            let startTime = 0;

            if (analyticsFilter === '7d') {
                startTime = now - (7 * 24 * 60 * 60 * 1000);
            } else if (analyticsFilter === '30d') {
                startTime = now - (30 * 24 * 60 * 60 * 1000);
            } else if (analyticsFilter === 'custom') {
                const input = document.getElementById('customDateInput').value;
                if(input) {
                    startTime = new Date(input).setHours(0,0,0,0);
                } else {
                    startTime = now - (7 * 24 * 60 * 60 * 1000);
                }
            }

            return state.sessions.filter(s => s.startTime >= startTime);
        }

        function renderAnalytics() { 
            const filteredSessions = getFilteredSessions();

            // 1. AI Analysis Logic
            const analysisContainer = document.getElementById('aiAnalysisResults');
            const subTotalsMap = {};
            let grandTotalSeconds = 0;

            filteredSessions.forEach(s => {
                if(!subTotalsMap[s.subjectId]) subTotalsMap[s.subjectId] = 0;
                subTotalsMap[s.subjectId] += s.duration;
                grandTotalSeconds += s.duration;
            });

            if (grandTotalSeconds > 0) {
                analysisContainer.classList.remove('hidden');
                
                const subjectStats = Object.keys(subTotalsMap).map(subId => {
                    const sub = state.subjects.find(s => s.id === subId);
                    return {
                        name: sub ? sub.name : 'Unknown',
                        time: subTotalsMap[subId],
                        percent: (subTotalsMap[subId] / grandTotalSeconds) * 100
                    };
                }).filter(s => s.time > 0); 

                subjectStats.sort((a, b) => b.time - a.time);

                document.getElementById('statMostRead').innerText = subjectStats.length > 0 ? subjectStats[0].name : '-';
                document.getElementById('statLeastRead').innerText = subjectStats.length > 0 ? subjectStats[subjectStats.length - 1].name : '-';

                const suggestions = subjectStats.filter(s => s.percent < 20);
                if (suggestions.length > 0) {
                    suggestions.sort((a,b) => b.percent - a.percent);
                    document.getElementById('statSuggestion').innerText = `Prioritize ${suggestions[0].name} (${suggestions[0].percent.toFixed(1)}% share)`;
                } else {
                    document.getElementById('statSuggestion').innerText = "Excellent balance maintained.";
                }

            } else {
                analysisContainer.classList.add('hidden');
            }

            // 2. Chart Data Logic (Time)
            const daysLabels = []; 
            const dataMap = {}; 
            let rangeDays = 7;
            if(analyticsFilter === '30d') rangeDays = 30;
            if(analyticsFilter === 'custom') rangeDays = 7; 

            for(let i = rangeDays-1; i >= 0; i--) { 
                const d = new Date(); 
                d.setDate(d.getDate() - i); 
                const dateKey = d.toDateString(); 
                daysLabels.push(d.toLocaleDateString('en-US', {weekday:'short'})); 
                dataMap[dateKey] = 0; 
            } 

            const chartStartTime = filteredSessions.length > 0 ? filteredSessions[0].startTime : Date.now();

            state.sessions.forEach(session => { 
                const sessionDate = new Date(session.startTime).toDateString(); 
                if (dataMap.hasOwnProperty(sessionDate) && session.startTime >= chartStartTime) { 
                    dataMap[sessionDate] += session.duration; 
                } 
            }); 
            const chartData = Object.values(dataMap).map(seconds => (seconds / 3600).toFixed(1));

            const distMap = {};
            filteredSessions.forEach(session => {
                if(!distMap[session.subjectId]) distMap[session.subjectId] = 0;
                distMap[session.subjectId] += session.duration;
            });
            const subData = Object.keys(distMap).map(subId => {
                const sub = state.subjects.find(s => s.id === subId);
                return sub ? {
                    name: sub.name,
                    color: sub.color,
                    hours: (distMap[subId] / 3600).toFixed(1)
                } : null;
            }).filter(item => item !== null && parseFloat(item.hours) > 0);

            // --- SMART CHART STYLING (TIME) ---
            const ctxDist = document.getElementById('distributionChart').getContext('2d'); 
            if (charts.dist) charts.dist.destroy(); 
            charts.dist = new Chart(ctxDist, { 
                type: 'doughnut', 
                data: { 
                    labels: subData.map(d => d.name), 
                    datasets: [{ 
                        data: subData.map(d => d.hours), 
                        backgroundColor: subData.map(d => d.color), 
                        borderWidth: 0,
                        hoverOffset: 10 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%',
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'Outfit', size: 12 }, boxWidth: 12, padding: 20, usePointStyle: true } },
                        tooltip: { backgroundColor: 'rgba(5, 5, 5, 0.9)', titleColor: '#fff', bodyColor: '#e2e8f0', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, padding: 12, cornerRadius: 8, displayColors: true, callbacks: { label: function(context) { return ` ${context.label}: ${context.raw}h`; } } }
                    } 
                } 
            }); 

            const ctxDaily = document.getElementById('dailyChart').getContext('2d'); 
            if (charts.daily) charts.daily.destroy(); 
            const gradient = ctxDaily.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, '#818cf8'); 
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.1)'); 

            charts.daily = new Chart(ctxDaily, { 
                type: 'line', 
                data: { 
                    labels: daysLabels, 
                    datasets: [{ 
                        label: 'Hours', 
                        data: chartData, 
                        backgroundColor: gradient,
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        pointBackgroundColor: '#1e1b4b',
                        pointBorderColor: '#818cf8',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.4, 
                        fill: true
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: { backgroundColor: 'rgba(5, 5, 5, 0.9)', titleColor: '#fff', bodyColor: '#e2e8f0', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: function(context) { return ` ${context.raw} Hours`; } } }
                    }, 
                    scales: { 
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.03)', borderDash: [5, 5] }, 
                            ticks: { color: '#64748b', font: { family: 'Outfit' }, callback: function(value) { return value + 'h'; } }, 
                            beginAtZero: true, 
                            border: { display: false }
                        }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#64748b', font: { family: 'Outfit' } },
                            border: { display: false }
                        } 
                    } 
                } 
            });

            // 3. SYLLABUS COVERAGE CHART (NEW)
            renderSyllabusChart();

            document.getElementById('recentSessions').innerHTML = [...filteredSessions].reverse().slice(0, 5).map(s => { 
                const sub = state.subjects.find(sub => sub.id === s.subjectId); 
                const hrs = Math.floor(s.duration / 3600);
                const mins = Math.round((s.duration % 3600) / 60);
                let timeStr = "";
                if (hrs > 0) timeStr += `${hrs}h `;
                timeStr += `${mins}m`;
                return `
                <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/5 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full" style="background:${sub ? sub.color : '#555'}"></div>
                        <div>
                            <p class="text-sm font-medium text-slate-200">${sub ? sub.name : 'Unknown'}</p>
                            <p class="text-[10px] text-slate-500 font-mono">${new Date(s.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>
                    <span class="font-mono text-sm text-indigo-400 font-bold bg-indigo-500/10 px-2 py-1 rounded border border-indigo-500/20">${timeStr}</span>
                </div>`; 
            }).join(''); 
        }

        function renderSyllabusChart() {
            const ctxSyllabus = document.getElementById('syllabusChart').getContext('2d');
            if (charts.syllabus) charts.syllabus.destroy();

            // Calculate Syllabus Progress for all Flow Subjects
            const flowData = flowState.subjects.map(sub => {
                let totalCells = 0;
                let doneCells = 0;

                // Total cells = Chapters * Columns
                totalCells = (sub.chapters.length * sub.columns.length);

                sub.chapters.forEach(ch => {
                    if (ch.cellData) {
                        sub.columns.forEach(col => {
                            const cell = ch.cellData[col];
                            // Cell could be object {status, note} or just string status
                            const status = (typeof cell === 'object') ? cell.status : cell;
                            if (status === 'done') doneCells++;
                        });
                    }
                });

                const percent = totalCells === 0 ? 0 : Math.round((doneCells / totalCells) * 100);
                return {
                    name: sub.name,
                    percent: percent
                };
            });

            if (flowData.length === 0) {
                // Handle empty state for canvas
                 if(charts.syllabus) charts.syllabus.destroy();
                 return;
            }

            charts.syllabus = new Chart(ctxSyllabus, {
                type: 'bar',
                data: {
                    labels: flowData.map(d => d.name),
                    datasets: [{
                        label: 'Completion %',
                        data: flowData.map(d => d.percent),
                        backgroundColor: '#22d3ee', // Cyan-400
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal Bar Chart
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8', callback: (val) => val + '%' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#e2e8f0', font: { family: 'Outfit', size: 12 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(5, 5, 5, 0.9)',
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.raw}% Completed`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        let titleFlashInterval = null;
        document.addEventListener('visibilitychange', () => {
            if (state.activeTimer && state.activeTimer.strictMode && document.hidden) {
                state.activeTimer.pause();
                focusBroken = true;
                if (!titleFlashInterval) {
                    let toggle = false;
                    titleFlashInterval = setInterval(() => { document.title = toggle ? " COME BACK!" : " FOCUS BROKEN"; toggle = !toggle; }, 800);
                }
            } 
            else if (!document.hidden && focusBroken) {
                if (titleFlashInterval) { clearInterval(titleFlashInterval); titleFlashInterval = null; }
                alert("FOCUS BROKEN!\n\nYou left the Focus Zone.\nThe timer paused automatically.\n\nResuming fullscreen now...");
                focusBroken = false;
                if (document.documentElement.requestFullscreen) { document.documentElement.requestFullscreen().catch(e => console.log(e)); }
            }
        });

        window.addEventListener('beforeunload', (e) => {
            if (state.activeTimer) { e.preventDefault(); e.returnValue = 'Timer is running! Are you sure you want to leave?'; }
        });

        // --- STUDY FLOW LOGIC ---
        
        function showFlowDashboard() {
            document.getElementById('flowDashboard').classList.remove('hidden');
            document.getElementById('flowDetailView').classList.add('hidden');
            renderFlowSubjects();
        }

        function openFlowSubject(id) {
            flowState.currentSubjectId = id;
            const subject = flowState.subjects.find(s => s.id === id);
            if(!subject) return;

            document.getElementById('flowDashboard').classList.add('hidden');
            document.getElementById('flowDetailView').classList.remove('hidden');
            document.getElementById('currentFlowSubjectTitle').textContent = subject.name;
            renderFlowTable();
        }

        // Calculate accurate percentage: (Total Done) / (Total Chapters * Total Columns)
        function calculateFlowSubjectProgress(sub) {
            if (sub.chapters.length === 0 || sub.columns.length === 0) return 0;
            
            const totalCells = sub.chapters.length * sub.columns.length;
            let doneCells = 0;

            sub.chapters.forEach(ch => {
                if(ch.cellData) {
                    sub.columns.forEach(col => {
                        const cell = ch.cellData[col];
                        // Handle legacy string format or new object format
                        const status = (typeof cell === 'object' && cell !== null) ? cell.status : cell;
                        if (status === 'done') doneCells++;
                    });
                }
            });

            return totalCells === 0 ? 0 : Math.round((doneCells / totalCells) * 100);
        }

        function renderFlowSubjects() {
            const list = document.getElementById('flowSubjectsGrid');
            const empty = document.getElementById('emptyFlowState');
            list.innerHTML = '';

            if (flowState.subjects.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            flowState.subjects.forEach(sub => {
                const percent = calculateFlowSubjectProgress(sub);

                const card = document.createElement('div');
                card.className = 'glass-card flow-card rounded-2xl p-6 relative overflow-hidden group';
                card.onclick = (e) => {
                    // Prevent opening if clicking action buttons
                    if(!e.target.closest('.flow-card-actions')) openFlowSubject(sub.id);
                };

                card.innerHTML = `
                    <div class="flow-card-actions absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="w-8 h-8 rounded-full bg-black/40 hover:bg-cyan-600 text-slate-300 hover:text-white flex items-center justify-center transition-colors backdrop-blur-md border border-white/10" 
                                onclick="editFlowSubject('${sub.id}')" title="Edit Subject">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button>
                        <button class="w-8 h-8 rounded-full bg-black/40 hover:bg-red-600 text-slate-300 hover:text-white flex items-center justify-center transition-colors backdrop-blur-md border border-white/10" 
                                onclick="deleteFlowSubject('${sub.id}', event)" title="Delete Subject">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>

                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center text-cyan-400">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3 class="font-bold text-xl text-slate-200">${sub.name}</h3>
                    </div>
                    <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">${sub.chapters.length} Chapters  ${sub.columns.length} Columns</div>
                    
                    <div class="mt-4">
                        <div class="flex justify-between text-xs text-slate-400 mb-1 font-medium">
                            <span>Completion</span>
                            <span class="text-slate-200 font-bold">${percent}%</span>
                        </div>
                        <div class="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-cyan-500 to-indigo-500" style="width:${percent}%"></div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // EDIT / CREATE SUBJECT LOGIC
        function openAddFlowSubjectModal() {
            flowState.editingSubjectId = null;
            document.getElementById('flowSubjectModalTitle').innerText = 'New Flow Subject';
            document.getElementById('flowSubjectName').value = '';
            document.getElementById('btnSaveFlowSubject').innerText = 'Create';
            document.getElementById('addFlowSubjectModal').classList.remove('hidden');
        }

        function editFlowSubject(id) {
            // Stop propagation handled in HTML, but good to have here just in case
            event.stopPropagation();
            
            const subject = flowState.subjects.find(s => s.id === id);
            if(!subject) return;

            flowState.editingSubjectId = id;
            document.getElementById('flowSubjectModalTitle').innerText = 'Edit Flow Subject';
            document.getElementById('flowSubjectName').value = subject.name;
            document.getElementById('btnSaveFlowSubject').innerText = 'Update';
            document.getElementById('addFlowSubjectModal').classList.remove('hidden');
        }

        function saveFlowSubject() {
            const name = document.getElementById('flowSubjectName').value.trim();
            if (!name) return;

            if (flowState.editingSubjectId) {
                // UPDATE EXISTING
                const subject = flowState.subjects.find(s => s.id === flowState.editingSubjectId);
                if (subject) {
                    subject.name = name;
                }
            } else {
                // CREATE NEW
                const newSubject = {
                    id: Date.now().toString(),
                    name: name,
                    columns: [...DEFAULT_COLUMNS],
                    chapters: []
                };
                flowState.subjects.push(newSubject);
            }

            saveFlowData();
            closeAddFlowSubjectModal();
            renderFlowSubjects();
        }

        function deleteFlowSubject(id, e) {
            if(e) e.stopPropagation();
            if(confirm('Are you sure you want to delete this subject? This cannot be undone.')) {
                flowState.subjects = flowState.subjects.filter(s => s.id !== id);
                saveFlowData();
                renderFlowSubjects();
            }
        }

        function renderFlowTable() {
            const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
            if (!subject) return;

            const headerRow = document.getElementById('flowHeaderRow'); 
            const tbody = document.getElementById('flowTableBody');
            const emptyState = document.getElementById('emptyFlowTable');

            // BUILD HEADERS
            let headersHtml = `
                <th class="flow-header-cell text-left rounded-tl-lg" style="min-width:220px">Chapter Name</th>
                <th class="flow-header-cell text-left w-56">Progress</th>
            `;

            // Add Dynamic Columns
            subject.columns.forEach(col => {
                headersHtml += `<th class="flow-header-cell text-left relative group" style="min-width: 140px;">
                                    ${col} 
                                    <i class="fas fa-times col-delete-btn cursor-pointer ml-2 text-slate-500 hover:text-red-400" onclick="deleteFlowColumn('${col}', event)"></i>
                                </th>`;
            });

            headersHtml += `<th class="flow-header-cell text-center w-16 rounded-tr-lg">Action</th>`;

            // INJECT HEADERS INTO DOM
            headerRow.innerHTML = headersHtml;
            tbody.innerHTML = '';

            if (subject.chapters.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }

            // RENDER ROWS
            subject.chapters.forEach((chapter) => {
                const tr = document.createElement('tr');
                tr.className = 'group';
                
                // Chapter Name
                let rowHtml = `
                    <td class="p-4 align-middle">
                        <input type="text" value="${chapter.name}" onchange="updateFlowChapterName('${chapter.id}', this.value)" 
                            class="flow-chapter-input" placeholder="Chapter Name"
                            title="${chapter.name}" oninput="this.title=this.value" onfocus="this.select()">
                    </td>
                `;

                // Progress
                const progress = calculateFlowChapterProgress(chapter, subject.columns);
                // Only apply explicit finished/not-finished status classes.
                // Treat empty string or 'pending' as automatic (no forced color), so progress color shows.
                let statusClass = '';
                if (chapter.status === 'finished') statusClass = 'status-finished';
                else if (chapter.status === 'not-finished') statusClass = 'status-not-finished';

                // Choose color class based on percent (user-driven progress -> green when high)
                let progressClass = 'prog-low';
                if (progress > 70) progressClass = 'prog-high';
                else if (progress > 30) progressClass = 'prog-med';

                rowHtml += `
                    <td class="align-middle">
                        <div class="flow-progress-wrapper ${statusClass}">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-slate-300">${progress}%</span>
                                <select class="flow-status-select" onchange="updateFlowChapterStatus('${chapter.id}', this.value)">
                                    <option value="" ${!chapter.status || chapter.status === '' ? 'selected' : ''}>Auto</option>
                                    <option value="pending" ${chapter.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="finished" ${chapter.status === 'finished' ? 'selected' : ''}>Finished</option>
                                    <option value="not-finished" ${chapter.status === 'not-finished' ? 'selected' : ''}>Not Finish</option>
                                </select>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill ${progressClass}" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </td>
                `;

                // Dynamic Cells
                subject.columns.forEach(col => {
                    let cellData = chapter.cellData && chapter.cellData[col];
                    if (typeof cellData === 'string') {
                        cellData = { status: cellData, note: '' };
                    }
                    if (!cellData) cellData = { status: '', note: '' };

                    const status = cellData.status;
                    const note = cellData.note;

                    let iconClass = '';
                    let iconHtml = '<i class="far fa-circle text-slate-600"></i>';
                    
                    if (status === 'done') {
                        iconClass = 'icon-done';
                        iconHtml = '<i class="fas fa-check"></i>';
                    } else if (status === 'skipped') {
                        iconClass = 'icon-skipped';
                        iconHtml = '<i class="fas fa-times"></i>';
                    }

                    rowHtml += `
                        <td class="p-2 align-middle text-center">
                            <div class="flow-cell-wrapper">
                                <div class="flow-cell-icon ${iconClass}" 
                                             onclick="toggleFlowCellStatus('${chapter.id}', '${col}')">
                                    ${iconHtml}
                                </div>
                                <div class="flow-note-cell" 
                                             contenteditable="true" 
                                             onblur="updateFlowCellNote('${chapter.id}', '${col}', this)"
                                             onkeydown="handleFlowNoteKey(event, this)"
                                             title="Click to add note">
                                    ${note ? note : '+ Note'}
                                </div>
                            </div>
                        </td>
                    `;
                });

                // Action
                rowHtml += `
                    <td class="p-4 text-center align-middle">
                        <button class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-500 hover:text-red-400 hover:bg-white/5 transition-colors" onclick="deleteFlowChapter('${chapter.id}')">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </td>
                `;

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        function toggleFlowCellStatus(chapterId, colName) {
            const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
            const chapter = subject.chapters.find(c => c.id === chapterId);
            
            if (!chapter.cellData) chapter.cellData = {};
            
            let cell = chapter.cellData[colName];
            if (typeof cell === 'string' || !cell) {
                cell = { status: '', note: '' };
            }

            if (cell.status === '' || cell.status === undefined) {
                cell.status = 'done';
            } else if (cell.status === 'done') {
                cell.status = 'skipped';
            } else {
                cell.status = '';
            }

            chapter.cellData[colName] = cell;
            saveFlowData();
            renderFlowTable();
            renderFlowSubjects(); // Update dashboard percent
        }

        function updateFlowCellNote(chapterId, colName, element) {
            const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
            const chapter = subject.chapters.find(c => c.id === chapterId);
            
            if (!chapter.cellData) chapter.cellData = {};
            
            let cell = chapter.cellData[colName];
            if (typeof cell === 'string' || !cell) {
                cell = { status: '', note: '' };
            }

            // If user cleared the text, reset to placeholder state logic
            let text = element.innerText.trim();
            if (text === '+ Note') text = '';

            cell.note = text;
            chapter.cellData[colName] = cell;
            saveFlowData();
        }

        function handleFlowNoteKey(e, element) {
            if (e.key === 'Enter') {
                e.preventDefault();
                element.blur();
            }
        }

        function addFlowChapter() {
            const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
            const newChapter = {
                id: Date.now().toString() + Math.random().toString().slice(2),
                name: "New Chapter",
                status: '',
                cellData: {}
            };

            subject.chapters.push(newChapter);
            saveFlowData();
            renderFlowTable();
        }

        function updateFlowChapterName(id, newName) {
            const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
            const chapter = subject.chapters.find(c => c.id === id);
            if(chapter) {
                chapter.name = newName;
                saveFlowData();
            }
        }

        function deleteFlowChapter(id) {
            if(confirm("Delete this chapter?")) {
                const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
                subject.chapters = subject.chapters.filter(c => c.id !== id);
                saveFlowData();
                renderFlowTable();
            }
        }

        function addFlowColumn() {
            const name = document.getElementById('flowColumnName').value.trim();
            if (!name) return;
            const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
            if(subject && !subject.columns.includes(name)) {
                subject.columns.push(name);
                saveFlowData();
                renderFlowTable();
            }
            closeAddFlowColumnModal();
            document.getElementById('flowColumnName').value = '';
        }

        function deleteFlowColumn(colName, e) {
            if(e) e.stopPropagation();
            if(confirm(`Remove column "${colName}"?`)) {
                const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
                subject.columns = subject.columns.filter(c => c !== colName);
                subject.chapters.forEach(ch => {
                    if(ch.cellData && ch.cellData[colName]) delete ch.cellData[colName];
                });
                saveFlowData();
                renderFlowTable();
            }
        }

        function updateFlowChapterStatus(id, newStatus) {
            const subject = flowState.subjects.find(s => s.id === flowState.currentSubjectId);
            const chapter = subject.chapters.find(c => c.id === id);
            if(chapter) {
                chapter.status = newStatus;
                saveFlowData();
                renderFlowTable();
            }
        }

        function calculateFlowChapterProgress(chapter, columns) {
            if (!chapter.cellData) return 0;
            let total = columns.length;
            let done = 0;
            
            columns.forEach(col => {
                const cell = chapter.cellData[col];
                if (cell && (typeof cell === 'object' ? cell.status === 'done' : cell === 'done')) {
                    done++;
                }
            });

            if (total === 0) return 0;
            return Math.round((done / total) * 100);
        }

        // Flow Modals
        function closeAddFlowSubjectModal() { 
            document.getElementById('addFlowSubjectModal').classList.add('hidden'); 
            document.getElementById('flowSubjectName').value = '';
            flowState.editingSubjectId = null;
        }
        
        function openAddFlowColumnModal() { document.getElementById('addFlowColumnModal').classList.remove('hidden'); }
        function closeAddFlowColumnModal() { document.getElementById('addFlowColumnModal').classList.add('hidden'); document.getElementById('flowColumnName').value = ''; }


        window.addEventListener('DOMContentLoaded', () => { 
            loadState(); 
            const lastDate = localStorage.getItem('ypt_last_date'); 
            const today = new Date().toDateString(); 
            if (lastDate !== today) { 
                if (lastDate) { state.todoHistory[lastDate] = [...state.todos]; } 
                state.todos = []; 
                state.subjects.forEach(s => s.totalTimeToday = 0); 
                saveState(); 
                localStorage.setItem('ypt_last_date', today); 
            } 
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric'}); 
            document.getElementById('mobileDate').innerText = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric'});
            renderSubjects(); 
            renderTodos(); 
            renderWeeklyHistory(); 
            updateSidebarStats(); 
            renderDailyGoals(); 
            renderUpcomingEvents(); 
            setInterval(renderUpcomingEvents, 60000); 
        });

    </script>
</body>
</html>